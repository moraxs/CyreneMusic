import 'dart:io';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:file_picker/file_picker.dart';
import 'package:url_launcher/url_launcher.dart';
import '../utils/theme_manager.dart';
import '../widgets/custom_color_picker_dialog.dart';
import '../models/song_detail.dart';
import '../models/version_info.dart';
import '../services/url_service.dart';
import '../services/auth_service.dart';
import '../services/location_service.dart';
import '../services/layout_preference_service.dart';
import '../services/cache_service.dart';
import '../services/download_service.dart';
import '../services/audio_quality_service.dart';
import '../services/version_service.dart';
import '../services/player_background_service.dart';
import '../pages/auth/login_page.dart';

/// ËÆæÁΩÆÈ°µÈù¢
class SettingsPage extends StatefulWidget {
  const SettingsPage({super.key});

  @override
  State<SettingsPage> createState() => _SettingsPageState();
}

class _SettingsPageState extends State<SettingsPage> {
  @override
  void initState() {
    super.initState();
    print('‚öôÔ∏è [SettingsPage] ÂàùÂßãÂåñËÆæÁΩÆÈ°µÈù¢...');
    
    // ÁõëÂê¨‰∏ªÈ¢òÂèòÂåñ
    ThemeManager().addListener(_onThemeChanged);
    // ÁõëÂê¨ URL ÊúçÂä°ÂèòÂåñ
    UrlService().addListener(_onUrlServiceChanged);
    // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
    AuthService().addListener(_onAuthChanged);
    // ÁõëÂê¨‰ΩçÁΩÆ‰ø°ÊÅØÂèòÂåñ
    LocationService().addListener(_onLocationChanged);
    // ÁõëÂê¨Â∏ÉÂ±ÄÂÅèÂ•ΩÂèòÂåñ
    LayoutPreferenceService().addListener(_onLayoutPreferenceChanged);
    // ÁõëÂê¨ÁºìÂ≠òÊúçÂä°ÂèòÂåñ
    CacheService().addListener(_onCacheChanged);
    // ÁõëÂê¨‰∏ãËΩΩÊúçÂä°ÂèòÂåñ
    DownloadService().addListener(_onDownloadChanged);
    // ÁõëÂê¨Èü≥Ë¥®ÊúçÂä°ÂèòÂåñ
    AudioQualityService().addListener(_onAudioQualityChanged);
    // ÁõëÂê¨Êí≠ÊîæÂô®ËÉåÊôØÊúçÂä°ÂèòÂåñ
    PlayerBackgroundService().addListener(_onPlayerBackgroundChanged);
    
    // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåËé∑Âèñ IP ÂΩíÂ±ûÂú∞
    final isLoggedIn = AuthService().isLoggedIn;
    print('‚öôÔ∏è [SettingsPage] ÂΩìÂâçÁôªÂΩïÁä∂ÊÄÅ: $isLoggedIn');
    
    if (isLoggedIn) {
      print('‚öôÔ∏è [SettingsPage] Áî®Êà∑Â∑≤ÁôªÂΩïÔºåÂºÄÂßãËé∑ÂèñIPÂΩíÂ±ûÂú∞...');
      LocationService().fetchLocation();
    } else {
      print('‚öôÔ∏è [SettingsPage] Áî®Êà∑Êú™ÁôªÂΩïÔºåË∑≥ËøáËé∑ÂèñIPÂΩíÂ±ûÂú∞');
    }
  }

  @override
  void dispose() {
    ThemeManager().removeListener(_onThemeChanged);
    UrlService().removeListener(_onUrlServiceChanged);
    AuthService().removeListener(_onAuthChanged);
    LocationService().removeListener(_onLocationChanged);
    LayoutPreferenceService().removeListener(_onLayoutPreferenceChanged);
    CacheService().removeListener(_onCacheChanged);
    DownloadService().removeListener(_onDownloadChanged);
    AudioQualityService().removeListener(_onAudioQualityChanged);
    PlayerBackgroundService().removeListener(_onPlayerBackgroundChanged);
    super.dispose();
  }

  void _onThemeChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onUrlServiceChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onAuthChanged() {
    if (mounted) {
      setState(() {});
      // ÁôªÂΩïÁä∂ÊÄÅÂèòÂåñÊó∂Ëé∑Âèñ/Ê∏ÖÈô§‰ΩçÁΩÆ‰ø°ÊÅØ
      if (AuthService().isLoggedIn) {
        print('üë§ [SettingsPage] Áî®Êà∑Â∑≤ÁôªÂΩïÔºåÂºÄÂßãËé∑ÂèñIPÂΩíÂ±ûÂú∞...');
        LocationService().fetchLocation();
      } else {
        print('üë§ [SettingsPage] Áî®Êà∑Â∑≤ÈÄÄÂá∫ÔºåÊ∏ÖÈô§IPÂΩíÂ±ûÂú∞...');
        LocationService().clearLocation();
      }
    }
  }

  void _onLocationChanged() {
    print('üåç [SettingsPage] ‰ΩçÁΩÆ‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞ÔºåÂà∑Êñ∞UI...');
    if (mounted) {
      setState(() {});
    }
  }

  void _onLayoutPreferenceChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onCacheChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onDownloadChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onAudioQualityChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  void _onPlayerBackgroundChanged() {
    if (mounted) {
      setState(() {});
    }
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    
    return Scaffold(
      backgroundColor: colorScheme.surface,
      body: CustomScrollView(
        slivers: [
          // È°∂ÈÉ®Ê†áÈ¢ò
          SliverAppBar(
            floating: true,
            snap: true,
            backgroundColor: colorScheme.surface,
            title: Text(
              'ËÆæÁΩÆ',
              style: TextStyle(
                color: colorScheme.onSurface,
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          
          // ËÆæÁΩÆÂÜÖÂÆπ
          SliverPadding(
            padding: const EdgeInsets.all(24.0),
            sliver: SliverList(
              delegate: SliverChildListDelegate([
                // Áî®Êà∑Âç°Áâá
                _buildUserCard(),
                const SizedBox(height: 24),
                
                // Â§ñËßÇËÆæÁΩÆ
                _buildSectionTitle('Â§ñËßÇ'),
                _buildSettingCard([
                  _buildSwitchTile(
                    title: 'Ê∑±Ëâ≤Ê®°Âºè',
                    subtitle: 'ÂêØÁî®Ê∑±Ëâ≤‰∏ªÈ¢ò',
                    icon: Icons.dark_mode,
                    value: ThemeManager().isDarkMode,
                    onChanged: (value) {
                      ThemeManager().toggleDarkMode(value);
                    },
                  ),
                  const Divider(height: 1),
                  _buildListTile(
                    title: '‰∏ªÈ¢òËâ≤',
                    subtitle: _getCurrentThemeColorName(),
                    icon: Icons.color_lens,
                    onTap: () => _showThemeColorPicker(),
                  ),
                  const Divider(height: 1),
                  _buildListTile(
                    title: 'Êí≠ÊîæÂô®ËÉåÊôØ',
                    subtitle: '${PlayerBackgroundService().getBackgroundTypeName()} - ${PlayerBackgroundService().getBackgroundTypeDescription()}',
                    icon: Icons.wallpaper,
                    onTap: () => _showPlayerBackgroundDialog(),
                  ),
                  // Windows Âπ≥Âè∞ÊòæÁ§∫Â∏ÉÂ±ÄÊ®°ÂºèÈÄâÊã©
                  if (Platform.isWindows) ...[
                    const Divider(height: 1),
                    _buildListTile(
                      title: 'Â∏ÉÂ±ÄÊ®°Âºè',
                      subtitle: LayoutPreferenceService().getLayoutDescription(),
                      icon: Icons.view_quilt,
                      onTap: () => _showLayoutModeDialog(),
                    ),
                  ],
                ]),
                
                const SizedBox(height: 24),
                
                // Êí≠ÊîæËÆæÁΩÆ
                _buildSectionTitle('Êí≠Êîæ'),
                _buildSettingCard([
                  _buildListTile(
                    title: 'Èü≥Ë¥®ÈÄâÊã©',
                    subtitle: '${AudioQualityService().getQualityName()} - ${AudioQualityService().getQualityDescription()}',
                    icon: Icons.high_quality,
                    onTap: () => _showAudioQualityDialog(),
                  ),
                ]),
                
                const SizedBox(height: 24),
                
                // ÁΩëÁªúËÆæÁΩÆ
                _buildSectionTitle('ÁΩëÁªú'),
                _buildSettingCard([
                  _buildListTile(
                    title: 'ÂêéÁ´ØÊ∫ê',
                    subtitle: UrlService().getSourceDescription(),
                    icon: Icons.dns,
                    onTap: () => _showBackendSourceDialog(),
                  ),
                  const Divider(height: 1),
                  _buildListTile(
                    title: 'ÊµãËØïËøûÊé•',
                    subtitle: 'ÊµãËØï‰∏éÂêéÁ´ØÊúçÂä°Âô®ÁöÑËøûÊé•',
                    icon: Icons.wifi_tethering,
                    onTap: () => _testConnection(),
                  ),
                ]),
                
                const SizedBox(height: 24),
                
                // Â≠òÂÇ®
                _buildSectionTitle('Â≠òÂÇ®'),
                _buildSettingCard([
                  _buildSwitchTile(
                    title: 'ÂêØÁî®ÁºìÂ≠ò',
                    subtitle: CacheService().cacheEnabled
                        ? 'Ëá™Âä®ÁºìÂ≠òÊí≠ÊîæËøáÁöÑÊ≠åÊõ≤'
                        : 'ÁºìÂ≠òÂ∑≤Á¶ÅÁî®',
                    icon: Icons.cloud_download,
                    value: CacheService().cacheEnabled,
                    onChanged: (value) async {
                      await CacheService().setCacheEnabled(value);
                      setState(() {});
                    },
                  ),
                  // Windows Âπ≥Âè∞ÊòæÁ§∫ÁºìÂ≠òÁõÆÂΩïËÆæÁΩÆ
                  if (Platform.isWindows) ...[
                    const Divider(height: 1),
                    _buildListTile(
                      title: 'ÁºìÂ≠òÁõÆÂΩï',
                      subtitle: _getCacheDirSubtitle(),
                      icon: Icons.folder,
                      onTap: () => _showCacheDirSettings(),
                    ),
                  ],
                  const Divider(height: 1),
                  _buildListTile(
                    title: 'ÁºìÂ≠òÁÆ°ÁêÜ',
                    subtitle: _getCacheSubtitle(),
                    icon: Icons.storage,
                    onTap: () => _showCacheManagement(),
                  ),
                  // Windows Âπ≥Âè∞ÊòæÁ§∫‰∏ãËΩΩÁõÆÂΩïËÆæÁΩÆ
                  if (Platform.isWindows) ...[
                    const Divider(height: 1),
                    _buildListTile(
                      title: '‰∏ãËΩΩÁõÆÂΩï',
                      subtitle: _getDownloadDirSubtitle(),
                      icon: Icons.download,
                      onTap: () => _showDownloadDirSettings(),
                    ),
                  ],
                ]),
                
                const SizedBox(height: 24),
                
                // ÂÖ≥‰∫é
                _buildSectionTitle('ÂÖ≥‰∫é'),
                _buildSettingCard([
                  _buildListTile(
                    title: 'ÁâàÊú¨‰ø°ÊÅØ',
                    subtitle: 'v${VersionService().currentVersion}',
                    icon: Icons.info_outline,
                    onTap: () => _showAboutDialog(),
                  ),
                  const Divider(height: 1),
                  _buildListTile(
                    title: 'Ê£ÄÊü•Êõ¥Êñ∞',
                    subtitle: 'Êü•ÁúãÊòØÂê¶ÊúâÊñ∞ÁâàÊú¨',
                    icon: Icons.system_update,
                    onTap: _checkForUpdate,
                  ),
                ]),
                
                const SizedBox(height: 40),
              ]),
            ),
          ),
        ],
      ),
    );
  }

  /// ÊûÑÂª∫ÂàÜÂå∫Ê†áÈ¢ò
  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0, left: 4.0),
      child: Text(
        title,
        style: Theme.of(context).textTheme.titleMedium?.copyWith(
          fontWeight: FontWeight.bold,
          color: Theme.of(context).colorScheme.primary,
        ),
      ),
    );
  }

  /// ÊûÑÂª∫ËÆæÁΩÆÂç°ÁâáÂÆπÂô®
  Widget _buildSettingCard(List<Widget> children) {
    return Card(
      child: Column(
        children: children,
      ),
    );
  }

  /// ÊûÑÂª∫ÊôÆÈÄöÂàóË°®È°π
  Widget _buildListTile({
    required String title,
    required String subtitle,
    required IconData icon,
    required VoidCallback onTap,
  }) {
    return ListTile(
      leading: Icon(icon),
      title: Text(title),
      subtitle: Text(subtitle),
      trailing: const Icon(Icons.chevron_right),
      onTap: onTap,
    );
  }

  /// ÊûÑÂª∫ÂºÄÂÖ≥ÂàóË°®È°π
  Widget _buildSwitchTile({
    required String title,
    required String subtitle,
    required IconData icon,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    return SwitchListTile(
      secondary: Icon(icon),
      title: Text(title),
      subtitle: Text(subtitle),
      value: value,
      onChanged: onChanged,
    );
  }

  /// Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òËâ≤ÂêçÁß∞
  String _getCurrentThemeColorName() {
    final currentIndex = ThemeManager().getCurrentColorIndex();
    return ThemeColors.presets[currentIndex].name;
  }

  /// ÊòæÁ§∫‰∏ªÈ¢òËâ≤ÈÄâÊã©Âô®
  void _showThemeColorPicker() {
    final currentIndex = ThemeManager().getCurrentColorIndex();
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄâÊã©‰∏ªÈ¢òËâ≤'),
        contentPadding: const EdgeInsets.symmetric(vertical: 20),
        content: SizedBox(
          width: double.maxFinite,
          child: GridView.builder(
            shrinkWrap: true,
            gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 3,
              childAspectRatio: 1.2,
              crossAxisSpacing: 12,
              mainAxisSpacing: 12,
            ),
            padding: const EdgeInsets.symmetric(horizontal: 24),
            itemCount: ThemeColors.presets.length + 1, // +1 for custom color option
            itemBuilder: (context, index) {
              // Ëá™ÂÆö‰πâÈ¢úËâ≤ÈÄâÈ°π
              if (index == ThemeColors.presets.length) {
                return InkWell(
                  onTap: () {
                    Navigator.pop(context);
                    _showCustomColorPicker();
                  },
                  borderRadius: BorderRadius.circular(12),
                  child: Container(
                    decoration: BoxDecoration(
                      color: Theme.of(context).colorScheme.surfaceContainerHighest,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: Theme.of(context).colorScheme.outline.withOpacity(0.3),
                        width: 2,
                      ),
                    ),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          width: 48,
                          height: 48,
                          decoration: BoxDecoration(
                            color: Theme.of(context).colorScheme.primaryContainer,
                            shape: BoxShape.circle,
                          ),
                          child: Icon(
                            Icons.add,
                            color: Theme.of(context).colorScheme.onPrimaryContainer,
                            size: 28,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'Ëá™ÂÆö‰πâ',
                          style: Theme.of(context).textTheme.bodySmall,
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                );
              }
              
              // È¢ÑËÆæÈ¢úËâ≤ÈÄâÈ°π
              final colorScheme = ThemeColors.presets[index];
              final isSelected = index == currentIndex;
              
              return InkWell(
                onTap: () {
                  ThemeManager().setSeedColor(colorScheme.color);
                  Navigator.pop(context);
                },
                borderRadius: BorderRadius.circular(12),
                child: Container(
                  decoration: BoxDecoration(
                    color: colorScheme.color.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: isSelected 
                          ? colorScheme.color 
                          : Colors.transparent,
                      width: 3,
                    ),
                  ),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: colorScheme.color,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          isSelected ? Icons.check : colorScheme.icon,
                          color: Colors.white,
                          size: 24,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        colorScheme.name,
                        style: Theme.of(context).textTheme.bodySmall,
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                ),
              );
            },
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂÖ≥Èó≠'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫Ëá™ÂÆö‰πâÈ¢úËâ≤ÈÄâÊã©Âô®
  void _showCustomColorPicker() {
    showDialog(
      context: context,
      builder: (context) => CustomColorPickerDialog(
        currentColor: ThemeManager().seedColor,
        onColorSelected: (color) {
          ThemeManager().setSeedColor(color);
        },
      ),
    );
  }

  /// ÊòæÁ§∫Â∏ÉÂ±ÄÊ®°ÂºèÈÄâÊã©ÂØπËØùÊ°Ü
  void _showLayoutModeDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄâÊã©Â∏ÉÂ±ÄÊ®°Âºè'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.5),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Icon(
                        Icons.info_outline,
                        size: 20,
                        color: Theme.of(context).colorScheme.primary,
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          'Windows ‰∏ìÂ±ûÂäüËÉΩ',
                          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            color: Theme.of(context).colorScheme.onPrimaryContainer,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '‚Ä¢ ÂàáÊç¢Â∏ÉÂ±ÄÊó∂Á™óÂè£‰ºöËá™Âä®Ë∞ÉÊï¥Â§ßÂ∞è\n‚Ä¢ Ê°åÈù¢Ê®°ÂºèÔºö1200x800\n‚Ä¢ ÁßªÂä®Ê®°ÂºèÔºö400x850ÔºàÁ´ñÂ±èÔºâ',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: Theme.of(context).colorScheme.onPrimaryContainer,
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            RadioListTile<LayoutMode>(
              title: const Text('Ê°åÈù¢Ê®°Âºè'),
              subtitle: const Text('‰æßËæπÂØºËà™Ê†èÔºåÊ®™Â±èÂÆΩÂ±èÂ∏ÉÂ±Ä'),
              secondary: const Icon(Icons.desktop_windows),
              value: LayoutMode.desktop,
              groupValue: LayoutPreferenceService().layoutMode,
              onChanged: (value) {
                LayoutPreferenceService().setLayoutMode(value!);
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Â∑≤ÂàáÊç¢Âà∞Ê°åÈù¢Ê®°ÂºèÔºåÁ™óÂè£Â∑≤Ë∞ÉÊï¥‰∏∫ 1200x800'),
                    duration: Duration(seconds: 2),
                  ),
                );
              },
            ),
            RadioListTile<LayoutMode>(
              title: const Text('ÁßªÂä®Ê®°Âºè'),
              subtitle: const Text('Â∫ïÈÉ®ÂØºËà™Ê†èÔºåÁ´ñÂ±èÊâãÊú∫Â∏ÉÂ±Ä'),
              secondary: const Icon(Icons.smartphone),
              value: LayoutMode.mobile,
              groupValue: LayoutPreferenceService().layoutMode,
              onChanged: (value) {
                LayoutPreferenceService().setLayoutMode(value!);
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Â∑≤ÂàáÊç¢Âà∞ÁßªÂä®Ê®°ÂºèÔºåÁ™óÂè£Â∑≤Ë∞ÉÊï¥‰∏∫ 400x850'),
                    duration: Duration(seconds: 2),
                  ),
                );
              },
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂÖ≥Èó≠'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫Èü≥Ë¥®ÈÄâÊã©ÂØπËØùÊ°Ü
  void _showAudioQualityDialog() {
    final currentQuality = AudioQualityService().currentQuality;
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄâÊã©Èü≥Ë¥®'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            RadioListTile<AudioQuality>(
              title: const Text('Ê†áÂáÜÈü≥Ë¥®'),
              subtitle: const Text('128kbpsÔºåËäÇÁúÅÊµÅÈáè'),
              value: AudioQuality.standard,
              groupValue: currentQuality,
              onChanged: (value) {
                if (value != null) {
                  AudioQualityService().setQuality(value);
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Èü≥Ë¥®ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞'),
                      duration: Duration(seconds: 1),
                    ),
                  );
                }
              },
            ),
            RadioListTile<AudioQuality>(
              title: const Text('ÊûÅÈ´òÈü≥Ë¥®'),
              subtitle: const Text('320kbpsÔºåÊé®Ëçê'),
              value: AudioQuality.exhigh,
              groupValue: currentQuality,
              onChanged: (value) {
                if (value != null) {
                  AudioQualityService().setQuality(value);
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Èü≥Ë¥®ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞'),
                      duration: Duration(seconds: 1),
                    ),
                  );
                }
              },
            ),
            RadioListTile<AudioQuality>(
              title: const Text('Êó†ÊçüÈü≥Ë¥®'),
              subtitle: const Text('FLACÔºåÈü≥Ë¥®ÊúÄ‰Ω≥'),
              value: AudioQuality.lossless,
              groupValue: currentQuality,
              onChanged: (value) {
                if (value != null) {
                  AudioQualityService().setQuality(value);
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Èü≥Ë¥®ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞'),
                      duration: Duration(seconds: 1),
                    ),
                  );
                }
              },
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂÖ≥Èó≠'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫ÂêéÁ´ØÊ∫êÈÄâÊã©ÂØπËØùÊ°Ü
  void _showBackendSourceDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄâÊã©ÂêéÁ´ØÊ∫ê'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            RadioListTile<BackendSourceType>(
              title: const Text('ÂÆòÊñπÊ∫ê'),
              subtitle: Text(
                'ÈªòËÆ§ÂêéÁ´ØÊúçÂä°',
                style: Theme.of(context).textTheme.bodySmall,
              ),
              value: BackendSourceType.official,
              groupValue: UrlService().sourceType,
              onChanged: (value) {
                UrlService().useOfficialSource();
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Â∑≤ÂàáÊç¢Âà∞ÂÆòÊñπÊ∫ê')),
                );
              },
            ),
            RadioListTile<BackendSourceType>(
              title: const Text('Ëá™ÂÆö‰πâÊ∫ê'),
              subtitle: Text(
                UrlService().customBaseUrl.isNotEmpty 
                    ? UrlService().customBaseUrl 
                    : 'ÁÇπÂáªËÆæÁΩÆËá™ÂÆö‰πâÂú∞ÂùÄ',
                style: Theme.of(context).textTheme.bodySmall,
              ),
              value: BackendSourceType.custom,
              groupValue: UrlService().sourceType,
              onChanged: (value) {
                Navigator.pop(context);
                _showCustomUrlDialog();
              },
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂÖ≥Èó≠'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫Ëá™ÂÆö‰πâ URL ËæìÂÖ•ÂØπËØùÊ°Ü
  void _showCustomUrlDialog() {
    final controller = TextEditingController(text: UrlService().customBaseUrl);
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Ëá™ÂÆö‰πâÂêéÁ´ØÊ∫ê'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.5),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.info_outline,
                    size: 20,
                    color: Theme.of(context).colorScheme.primary,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'ËØ∑Á°Æ‰øùËá™ÂÆö‰πâÊ∫êÁ¨¶Âêà OmniParse Ê†áÂáÜ',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: Theme.of(context).colorScheme.onPrimaryContainer,
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: controller,
              decoration: const InputDecoration(
                labelText: 'ÂêéÁ´ØÂú∞ÂùÄ',
                hintText: 'http://example.com:4055',
                prefixIcon: Icon(Icons.link),
                border: OutlineInputBorder(),
                helperText: '‰∏çË¶ÅÂú®Êú´Â∞æÊ∑ªÂä†ÊñúÊù†',
              ),
              keyboardType: TextInputType.url,
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂèñÊ∂à'),
          ),
          FilledButton(
            onPressed: () {
              final url = controller.text.trim();
              
              if (url.isEmpty) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('ËØ∑ËæìÂÖ•ÂêéÁ´ØÂú∞ÂùÄ')),
                );
                return;
              }
              
              if (!UrlService.isValidUrl(url)) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('URL Ê†ºÂºè‰∏çÊ≠£Á°Æ')),
                );
                return;
              }
              
              UrlService().useCustomSource(url);
              Navigator.pop(context);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('Â∑≤ÂàáÊç¢Âà∞Ëá™ÂÆö‰πâÊ∫ê: $url')),
              );
            },
            child: const Text('‰øùÂ≠ò'),
          ),
        ],
      ),
    );
  }

  /// ÊµãËØïËøûÊé•
  Future<void> _testConnection() async {
    // ÊòæÁ§∫Âä†ËΩΩÂØπËØùÊ°Ü
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    final baseUrl = UrlService().baseUrl;
    bool isSuccess = false;
    String errorMessage = '';

    try {
      // ÂèëÈÄÅ GET ËØ∑Ê±ÇÂà∞Ê†πË∑ØÂæÑ
      final response = await http.get(
        Uri.parse(baseUrl),
      ).timeout(
        const Duration(seconds: 10),
        onTimeout: () {
          throw Exception('ËøûÊé•Ë∂ÖÊó∂');
        },
      );

      // Ê£ÄÊü•ÂìçÂ∫îÁ†ÅÊòØÂê¶‰∏∫ 200 ‰∏îÂìçÂ∫î‰ΩìÊòØ "OK"
      if (response.statusCode == 200 && response.body.trim() == 'OK') {
        isSuccess = true;
      } else {
        errorMessage = 'ÂìçÂ∫îÁ†Å: ${response.statusCode}\nÂìçÂ∫îÂÜÖÂÆπ: ${response.body}';
      }
    } catch (e) {
      errorMessage = e.toString();
    }

    // ÂÖ≥Èó≠Âä†ËΩΩÂØπËØùÊ°Ü
    if (mounted) {
      Navigator.pop(context);

      // ÊòæÁ§∫ÁªìÊûúÂØπËØùÊ°Ü
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: Row(
            children: [
              Icon(
                isSuccess ? Icons.check_circle : Icons.error,
                color: isSuccess
                    ? Theme.of(context).colorScheme.primary
                    : Theme.of(context).colorScheme.error,
              ),
              const SizedBox(width: 8),
              const Text('ËøûÊé•ÊµãËØï'),
            ],
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('ÂêéÁ´ØÂú∞ÂùÄ: $baseUrl'),
              const SizedBox(height: 12),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: isSuccess
                      ? Theme.of(context).colorScheme.primaryContainer
                      : Theme.of(context).colorScheme.errorContainer,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    Icon(
                      isSuccess ? Icons.done : Icons.close,
                      color: isSuccess
                          ? Theme.of(context).colorScheme.onPrimaryContainer
                          : Theme.of(context).colorScheme.onErrorContainer,
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Text(
                        isSuccess ? 'ËøûÊé•ÊàêÂäü' : 'ËøûÊé•Â§±Ë¥•',
                        style: TextStyle(
                          color: isSuccess
                              ? Theme.of(context).colorScheme.onPrimaryContainer
                              : Theme.of(context).colorScheme.onErrorContainer,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              if (!isSuccess) ...[
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Theme.of(context).colorScheme.surfaceContainerHighest,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'ÈîôËØØËØ¶ÊÉÖ:',
                        style: Theme.of(context).textTheme.labelSmall,
                      ),
                      const SizedBox(height: 4),
                      Text(
                        errorMessage,
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          fontFamily: 'monospace',
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
          actions: [
            FilledButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Á°ÆÂÆö'),
            ),
          ],
        ),
      );
    }
  }

  /// ÊòæÁ§∫ÂÖ≥‰∫éÂØπËØùÊ°Ü
  void _showAboutDialog() {
    showAboutDialog(
      context: context,
      applicationName: 'Cyrene Music',
      applicationVersion: VersionService().currentVersion,
      applicationIcon: const Icon(Icons.music_note, size: 48),
      children: [
        const Text('‰∏Ä‰∏™Ë∑®Âπ≥Âè∞ÁöÑÈü≥‰πê‰∏éËßÜÈ¢ëËÅöÂêàÊí≠ÊîæÂô®'),
        const SizedBox(height: 16),
        const Text('ÊîØÊåÅÁΩëÊòì‰∫ëÈü≥‰πê„ÄÅQQÈü≥‰πê„ÄÅÈÖ∑ÁãóÈü≥‰πê„ÄÅBilibiliÁ≠âÂπ≥Âè∞'),
      ],
    );
  }

  /// Ê£ÄÊü•Êõ¥Êñ∞
  Future<void> _checkForUpdate() async {
    // ÊòæÁ§∫Âä†ËΩΩÂØπËØùÊ°Ü
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    try {
      print('üîç [SettingsPage] ÂºÄÂßãÊ£ÄÊü•Êõ¥Êñ∞...');
      
      final versionInfo = await VersionService().checkForUpdate(silent: false);
      
      if (!mounted) return;
      
      // ÂÖ≥Èó≠Âä†ËΩΩÂØπËØùÊ°Ü
      Navigator.pop(context);
      
      if (versionInfo != null && VersionService().hasUpdate) {
        print('‚úÖ [SettingsPage] ÂèëÁé∞Êñ∞ÁâàÊú¨: ${versionInfo.version}');
        _showUpdateDialog(versionInfo);
      } else {
        print('‚úÖ [SettingsPage] Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨');
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Row(
              children: [
                Icon(Icons.check_circle, color: Colors.white),
                SizedBox(width: 12),
                Text('Â∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨'),
              ],
            ),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      print('‚ùå [SettingsPage] Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•: $e');
      
      if (!mounted) return;
      
      // ÂÖ≥Èó≠Âä†ËΩΩÂØπËØùÊ°Ü
      Navigator.pop(context);
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              const Icon(Icons.error_outline, color: Colors.white),
              const SizedBox(width: 12),
              Expanded(child: Text('Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•: $e')),
            ],
          ),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  /// ÊòæÁ§∫Êõ¥Êñ∞ÊèêÁ§∫ÂØπËØùÊ°Ü
  void _showUpdateDialog(VersionInfo versionInfo) {
    if (!mounted) return;

    final isForceUpdate = versionInfo.forceUpdate;

    showDialog(
      context: context,
      barrierDismissible: !isForceUpdate,
      builder: (context) => PopScope(
        canPop: !isForceUpdate,
        child: AlertDialog(
          title: const Row(
            children: [
              Icon(Icons.system_update, size: 28),
              SizedBox(width: 12),
              Text('ÂèëÁé∞Êñ∞ÁâàÊú¨'),
            ],
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // ÁâàÊú¨‰ø°ÊÅØ
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.5),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'ÊúÄÊñ∞ÁâàÊú¨',
                                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                versionInfo.version,
                                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                                  color: Theme.of(context).colorScheme.primary,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.end,
                            children: [
                              Text(
                                'ÂΩìÂâçÁâàÊú¨',
                                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                VersionService().currentVersion,
                                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 20),

                // Êõ¥Êñ∞ÂÜÖÂÆπ
                Text(
                  'Êõ¥Êñ∞ÂÜÖÂÆπ',
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Theme.of(context).colorScheme.surfaceContainerHighest,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    versionInfo.changelog,
                    style: Theme.of(context).textTheme.bodyMedium,
                  ),
                ),

                // Âº∫Âà∂Êõ¥Êñ∞ÊèêÁ§∫
                if (isForceUpdate) ...[
                  const SizedBox(height: 16),
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Theme.of(context).colorScheme.errorContainer,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          Icons.warning,
                          color: Theme.of(context).colorScheme.error,
                          size: 24,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            'Ê≠§ÁâàÊú¨‰∏∫Âº∫Âà∂Êõ¥Êñ∞\nËØ∑Á´ãÂç≥Êõ¥Êñ∞',
                            style: TextStyle(
                              color: Theme.of(context).colorScheme.onErrorContainer,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ],
            ),
          ),
          actions: [
            // Á®çÂêéÊèêÈÜíÊåâÈíÆÔºà‰ªÖÈùûÂº∫Âà∂Êõ¥Êñ∞Êó∂ÊòæÁ§∫Ôºâ
            if (!isForceUpdate)
              TextButton(
                onPressed: () async {
                  await VersionService().ignoreCurrentVersion(versionInfo.version);
                  if (mounted) {
                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Â∑≤ÂøΩÁï•ÁâàÊú¨ ${versionInfo.version}ÔºåÊúâÊñ∞ÁâàÊú¨Êó∂Â∞ÜÂÜçÊ¨°ÊèêÈÜí'),
                        duration: const Duration(seconds: 2),
                      ),
                    );
                  }
                },
                child: const Text('Á®çÂêéÊèêÈÜí'),
              ),

            // Á´ãÂç≥Êõ¥Êñ∞ÊåâÈíÆ
            FilledButton.icon(
              onPressed: () async {
                final url = versionInfo.downloadUrl;
                print('üîó [SettingsPage] ÊâìÂºÄ‰∏ãËΩΩÈìæÊé•: $url');

                try {
                  final uri = Uri.parse(url);
                  if (await canLaunchUrl(uri)) {
                    await launchUrl(uri, mode: LaunchMode.externalApplication);
                    print('‚úÖ [SettingsPage] Â∑≤ÊâìÂºÄÊµèËßàÂô®');
                  } else {
                    throw Exception('Êó†Ê≥ïÊâìÂºÄÈìæÊé•');
                  }
                } catch (e) {
                  print('‚ùå [SettingsPage] ÊâìÂºÄÈìæÊé•Â§±Ë¥•: $e');
                  if (mounted) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('ÊâìÂºÄÈìæÊé•Â§±Ë¥•: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                }
              },
              icon: const Icon(Icons.download),
              label: const Text('Á´ãÂç≥Êõ¥Êñ∞'),
            ),
          ],
        ),
      ),
    );
  }

  /// ÊûÑÂª∫Áî®Êà∑Âç°Áâá
  Widget _buildUserCard() {
    final isLoggedIn = AuthService().isLoggedIn;
    final user = AuthService().currentUser;
    
    if (!isLoggedIn || user == null) {
      // Êú™ÁôªÂΩïÁä∂ÊÄÅ
      return _buildLoginCard();
    }
    
    // Â∑≤ÁôªÂΩïÁä∂ÊÄÅ
    return _buildUserInfoCard(user);
  }

  /// ÊûÑÂª∫ÁôªÂΩïÂç°ÁâáÔºàÊú™ÁôªÂΩïÁä∂ÊÄÅÔºâ
  Widget _buildLoginCard() {
    final colorScheme = Theme.of(context).colorScheme;
    
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Row(
          children: [
            Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: colorScheme.primaryContainer,
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.person_outline,
                size: 32,
                color: colorScheme.onPrimaryContainer,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Êú™ÁôªÂΩï',
                    style: Theme.of(context).textTheme.titleMedium?.copyWith(
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'ÁôªÂΩïÂêéÂèØ‰∫´ÂèóÊõ¥Â§öÂäüËÉΩ',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: colorScheme.onSurfaceVariant,
                    ),
                  ),
                ],
              ),
            ),
            FilledButton(
              onPressed: _handleLogin,
              child: const Text('ÁôªÂΩï'),
            ),
          ],
        ),
      ),
    );
  }

  /// ÊûÑÂª∫Áî®Êà∑‰ø°ÊÅØÂç°ÁâáÔºàÂ∑≤ÁôªÂΩïÁä∂ÊÄÅÔºâ
  Widget _buildUserInfoCard(User user) {
    final colorScheme = Theme.of(context).colorScheme;
    final qqNumber = _extractQQNumber(user.email);
    final avatarUrl = _getQQAvatarUrl(qqNumber);
    
    // ‰ΩøÁî® AnimatedBuilder Á°Æ‰øùÁä∂ÊÄÅÊõ¥Êñ∞
    return AnimatedBuilder(
      animation: LocationService(),
      builder: (context, child) {
        final location = LocationService().currentLocation;
        final isLoadingLocation = LocationService().isLoading;
        final errorMessage = LocationService().errorMessage;
        
        print('üì± [SettingsPage] ÊûÑÂª∫Áî®Êà∑Âç°Áâá - Áî®Êà∑: ${user.username}');
        print('üì± [SettingsPage] ‰ΩçÁΩÆÂä†ËΩΩ‰∏≠: $isLoadingLocation');
        print('üì± [SettingsPage] ‰ΩçÁΩÆ‰ø°ÊÅØ: ${location?.shortDescription ?? "null"}');
        print('üì± [SettingsPage] ÈîôËØØ‰ø°ÊÅØ: ${errorMessage ?? "Êó†"}');
        
        return Card(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    // QQ Â§¥ÂÉè
                    CircleAvatar(
                      radius: 30,
                      backgroundColor: colorScheme.primaryContainer,
                      backgroundImage: avatarUrl != null 
                          ? NetworkImage(avatarUrl) 
                          : null,
                      child: avatarUrl == null 
                          ? Icon(
                              Icons.person,
                              size: 32,
                              color: colorScheme.onPrimaryContainer,
                            )
                          : null,
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Áî®Êà∑Âêç
                          Text(
                            user.username,
                            style: Theme.of(context).textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 4),
                          // ÈÇÆÁÆ±
                          Row(
                            children: [
                              Icon(
                                Icons.email_outlined,
                                size: 14,
                                color: colorScheme.onSurfaceVariant,
                              ),
                              const SizedBox(width: 4),
                              Expanded(
                                child: Text(
                                  user.email,
                                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                    color: colorScheme.onSurfaceVariant,
                                  ),
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 2),
                          // IP ÂΩíÂ±ûÂú∞
                          Row(
                            children: [
                              Icon(
                                Icons.location_on_outlined,
                                size: 14,
                                color: colorScheme.onSurfaceVariant,
                              ),
                              const SizedBox(width: 4),
                              if (isLoadingLocation)
                                Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    SizedBox(
                                      width: 12,
                                      height: 12,
                                      child: CircularProgressIndicator(
                                        strokeWidth: 2,
                                        color: colorScheme.onSurfaceVariant,
                                      ),
                                    ),
                                    const SizedBox(width: 4),
                                    Text(
                                      'Ëé∑Âèñ‰∏≠...',
                                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                        color: colorScheme.onSurfaceVariant,
                                      ),
                                    ),
                                  ],
                                )
                              else if (location != null)
                                Expanded(
                                  child: Text(
                                    location.shortDescription,
                                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                      color: colorScheme.onSurfaceVariant,
                                    ),
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                )
                              else
                                Expanded(
                                  child: Row(
                                    children: [
                                      Text(
                                        'Ëé∑ÂèñÂ§±Ë¥•',
                                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                          color: colorScheme.error,
                                        ),
                                      ),
                                      const SizedBox(width: 4),
                                      InkWell(
                                        onTap: () {
                                          print('üîÑ [SettingsPage] ÊâãÂä®Âà∑Êñ∞IPÂΩíÂ±ûÂú∞...');
                                          LocationService().fetchLocation();
                                        },
                                        child: Icon(
                                          Icons.refresh,
                                          size: 14,
                                          color: colorScheme.primary,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                            ],
                          ),
                        ],
                      ),
                    ),
                    // ÈÄÄÂá∫ÊåâÈíÆ
                    IconButton(
                      onPressed: _handleLogout,
                      icon: const Icon(Icons.logout),
                      tooltip: 'ÈÄÄÂá∫ÁôªÂΩï',
                    ),
                  ],
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  /// ‰ªéÈÇÆÁÆ±‰∏≠ÊèêÂèñ QQ Âè∑
  String? _extractQQNumber(String email) {
    // Âà§Êñ≠ÊòØÂê¶ÊòØ QQ ÈÇÆÁÆ±Ê†ºÂºè (Êï∞Â≠ó@qq.com)
    final qqEmailPattern = RegExp(r'^(\d+)@qq\.com$');
    final match = qqEmailPattern.firstMatch(email.toLowerCase());
    
    if (match != null && match.groupCount >= 1) {
      return match.group(1);
    }
    
    return null;
  }

  /// Ëé∑Âèñ QQ Â§¥ÂÉè URL
  String? _getQQAvatarUrl(String? qqNumber) {
    if (qqNumber == null || qqNumber.isEmpty) {
      return null;
    }
    
    // QQ Â§¥ÂÉè URL Ê†ºÂºè: https://q1.qlogo.cn/g?b=qq&nk={QQÂè∑}&s=100
    return 'https://q1.qlogo.cn/g?b=qq&nk=$qqNumber&s=100';
  }

  /// Â§ÑÁêÜÁôªÂΩï
  Future<void> _handleLogin() async {
    print('üë§ [SettingsPage] ÊâìÂºÄÁôªÂΩïÈ°µÈù¢...');
    
    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const LoginPage(),
      ),
    );
    
    print('üë§ [SettingsPage] ÁôªÂΩïÈ°µÈù¢ËøîÂõûÔºåÁªìÊûú: $result');
    print('üë§ [SettingsPage] ÂΩìÂâçÁôªÂΩïÁä∂ÊÄÅ: ${AuthService().isLoggedIn}');
    
    // Â¶ÇÊûúÁôªÂΩïÊàêÂäüÔºåËé∑Âèñ‰ΩçÁΩÆ‰ø°ÊÅØ
    if (result == true && AuthService().isLoggedIn) {
      print('üë§ [SettingsPage] ÁôªÂΩïÊàêÂäüÔºåÂºÄÂßãËé∑ÂèñIPÂΩíÂ±ûÂú∞...');
      LocationService().fetchLocation();
    }
  }

  /// Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩï
  void _handleLogout() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄÄÂá∫ÁôªÂΩï'),
        content: const Text('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂèñÊ∂à'),
          ),
          FilledButton(
            onPressed: () {
              AuthService().logout();
              LocationService().clearLocation();
              Navigator.pop(context);
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Â∑≤ÈÄÄÂá∫ÁôªÂΩï')),
              );
            },
            child: const Text('ÈÄÄÂá∫'),
          ),
        ],
      ),
    );
  }

  /// Ëé∑ÂèñÁºìÂ≠òÂâØÊ†áÈ¢ò
  String _getCacheSubtitle() {
    if (!CacheService().isInitialized) {
      return 'ÂàùÂßãÂåñ‰∏≠...';
    }

    if (!CacheService().cacheEnabled) {
      return 'ÁºìÂ≠òÂäüËÉΩÂ∑≤Á¶ÅÁî®';
    }

    final count = CacheService().cachedCount;
    if (count == 0) {
      return 'ÊöÇÊó†ÁºìÂ≠ò';
    }

    return 'Â∑≤ÁºìÂ≠ò $count È¶ñÊ≠åÊõ≤';
  }

  /// Ëé∑ÂèñÁºìÂ≠òÁõÆÂΩïÂâØÊ†áÈ¢ò
  String _getCacheDirSubtitle() {
    final customDir = CacheService().customCacheDir;
    if (customDir != null && customDir.isNotEmpty) {
      return 'Ëá™ÂÆö‰πâÔºö$customDir';
    }
    return 'ÈªòËÆ§‰ΩçÁΩÆ';
  }

  /// Ëé∑Âèñ‰∏ãËΩΩÁõÆÂΩïÂâØÊ†áÈ¢ò
  String _getDownloadDirSubtitle() {
    final downloadPath = DownloadService().downloadPath;
    if (downloadPath != null && downloadPath.isNotEmpty) {
      return downloadPath;
    }
    return 'Êú™ËÆæÁΩÆ';
  }

  /// ÊòæÁ§∫ÁºìÂ≠òÁÆ°ÁêÜ
  Future<void> _showCacheManagement() async {
    final stats = await CacheService().getCacheStats();

    if (!mounted) return;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Row(
          children: [
            Icon(Icons.storage),
            SizedBox(width: 8),
            Text('ÁºìÂ≠òÁÆ°ÁêÜ'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Âç†Áî®Á©∫Èó¥
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.5),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Âç†Áî®Á©∫Èó¥',
                        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                          color: Theme.of(context).colorScheme.onSurfaceVariant,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        stats.formattedSize,
                        style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).colorScheme.primary,
                        ),
                      ),
                    ],
                  ),
                  Icon(
                    Icons.folder_outlined,
                    size: 48,
                    color: Theme.of(context).colorScheme.primary.withOpacity(0.3),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            // Êñá‰ª∂Êï∞Èáè
            Row(
              children: [
                Icon(
                  Icons.audiotrack,
                  size: 20,
                  color: Theme.of(context).colorScheme.onSurfaceVariant,
                ),
                const SizedBox(width: 8),
                Text(
                  'Â∑≤ÁºìÂ≠ò ${stats.totalFiles} È¶ñÊ≠åÊõ≤',
                  style: Theme.of(context).textTheme.bodyMedium,
                ),
              ],
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂÖ≥Èó≠'),
          ),
          if (stats.totalFiles > 0)
            FilledButton.icon(
              onPressed: () {
                Navigator.pop(context);
                _confirmClearCache();
              },
              icon: const Icon(Icons.delete_sweep),
              label: const Text('Ê∏ÖÈô§ÁºìÂ≠ò'),
              style: FilledButton.styleFrom(
                backgroundColor: Theme.of(context).colorScheme.error,
              ),
            ),
        ],
      ),
    );
  }

  /// ÊûÑÂª∫ÁºìÂ≠òÁªüËÆ°Ë°å
  Widget _buildCacheStatRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label),
          Text(
            value,
            style: const TextStyle(fontWeight: FontWeight.bold),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫ÁºìÂ≠òÁõÆÂΩïËÆæÁΩÆ
  Future<void> _showCacheDirSettings() async {
    final currentCustomDir = CacheService().customCacheDir;
    final currentDir = CacheService().currentCacheDir;
    final defaultDir = await CacheService().getDefaultCacheDir();
    
    final dirController = TextEditingController(text: currentCustomDir ?? '');

    if (!mounted) return;

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          title: const Row(
            children: [
              Icon(Icons.folder),
              SizedBox(width: 8),
              Text('ÁºìÂ≠òÁõÆÂΩïËÆæÁΩÆ'),
            ],
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'ÂΩìÂâçÁõÆÂΩïÔºö',
                  style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                ),
                const SizedBox(height: 8),
                SelectableText(
                  currentDir ?? 'Êú™Áü•',
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontFamily: 'monospace',
                        color: Theme.of(context).colorScheme.primary,
                      ),
                ),
                const SizedBox(height: 16),
                const Divider(),
                const SizedBox(height: 16),
                Text(
                  'ÈªòËÆ§ÁõÆÂΩïÔºö',
                  style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                ),
                const SizedBox(height: 8),
                SelectableText(
                  defaultDir,
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontFamily: 'monospace',
                      ),
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: dirController,
                        decoration: const InputDecoration(
                          labelText: 'Ëá™ÂÆö‰πâÁõÆÂΩïÔºàÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§Ôºâ',
                          hintText: '‰æãÔºöD:\\Music\\Cache',
                          prefixIcon: Icon(Icons.edit_location),
                          border: OutlineInputBorder(),
                        ),
                        maxLines: 1,
                      ),
                    ),
                    const SizedBox(width: 8),
                    IconButton.filledTonal(
                      onPressed: () async {
                        // ÊâìÂºÄÁõÆÂΩïÈÄâÊã©Âô®
                        String? selectedDirectory = await FilePicker.platform.getDirectoryPath(
                          dialogTitle: 'ÈÄâÊã©ÁºìÂ≠òÁõÆÂΩï',
                          lockParentWindow: true,
                        );

                        if (selectedDirectory != null) {
                          setState(() {
                            dirController.text = selectedDirectory;
                          });
                        }
                      },
                      icon: const Icon(Icons.folder_open),
                      tooltip: 'ÊµèËßàÈÄâÊã©ÁõÆÂΩï',
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Theme.of(context).colorScheme.surfaceVariant,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(
                            Icons.info_outline,
                            size: 16,
                            color: Theme.of(context).colorScheme.primary,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            'ÊèêÁ§∫',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Theme.of(context).colorScheme.primary,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Text(
                        '‚Ä¢ ÁÇπÂáªÊñá‰ª∂Â§πÂõæÊ†áÈÄâÊã©ÁõÆÂΩï\n'
                        '‚Ä¢ Êõ¥ÊîπÁõÆÂΩïÈúÄË¶ÅÈáçÂêØÂ∫îÁî®ÁîüÊïà\n'
                        '‚Ä¢ Á°Æ‰øùÁõÆÂΩïÊúâËØªÂÜôÊùÉÈôê\n'
                        '‚Ä¢ ÊóßÁºìÂ≠ò‰∏ç‰ºöËá™Âä®ËøÅÁßª',
                        style: Theme.of(context).textTheme.bodySmall,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          actions: [
            if (currentCustomDir != null && currentCustomDir.isNotEmpty)
              TextButton.icon(
                onPressed: () async {
                  final success = await CacheService().setCustomCacheDir(null);
                  if (success && mounted) {
                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text('Â∑≤ÊÅ¢Â§çÈªòËÆ§ÁõÆÂΩïÔºåËØ∑ÈáçÂêØÂ∫îÁî®ÁîüÊïà'),
                      ),
                    );
                  }
                },
                icon: const Icon(Icons.restore),
                label: const Text('ÊÅ¢Â§çÈªòËÆ§'),
              ),
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('ÂèñÊ∂à'),
            ),
            FilledButton(
              onPressed: () async {
                final newDir = dirController.text.trim();
                
                if (newDir.isEmpty || newDir == currentCustomDir) {
                  Navigator.pop(context);
                  return;
                }

                // È™åËØÅÂπ∂‰øùÂ≠ò
                final success = await CacheService().setCustomCacheDir(newDir);
                
                if (mounted) {
                  Navigator.pop(context);
                  if (success) {
                    // ÊòæÁ§∫Êõ¥ÊòéÊòæÁöÑÈáçÂêØÊèêÁ§∫
                    showDialog(
                      context: context,
                      builder: (context) => AlertDialog(
                        icon: const Icon(Icons.restart_alt, size: 48),
                        title: const Text('ÈúÄË¶ÅÈáçÂêØÂ∫îÁî®'),
                        content: Column(
                          mainAxisSize: MainAxisSize.min,
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'ÁºìÂ≠òÁõÆÂΩïÂ∑≤ËÆæÁΩÆ‰∏∫Ôºö',
                              style: Theme.of(context).textTheme.titleSmall,
                            ),
                            const SizedBox(height: 8),
                            SelectableText(
                              newDir,
                              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                                fontWeight: FontWeight.bold,
                                color: Theme.of(context).colorScheme.primary,
                              ),
                            ),
                            const SizedBox(height: 16),
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Theme.of(context).colorScheme.errorContainer,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Row(
                                children: [
                                  Icon(
                                    Icons.warning,
                                    color: Theme.of(context).colorScheme.error,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Expanded(
                                    child: Text(
                                      'ÂøÖÈ°ªÈáçÂêØÂ∫îÁî®ÊâçËÉΩ‰ΩøÁî®Êñ∞ÁõÆÂΩïÔºÅ\nÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤‰ªç‰ºöÁºìÂ≠òÂà∞ÊóßÁõÆÂΩï„ÄÇ',
                                      style: TextStyle(
                                        color: Theme.of(context).colorScheme.onErrorContainer,
                                        fontSize: 12,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                        actions: [
                          FilledButton(
                            onPressed: () => Navigator.pop(context),
                            child: const Text('Áü•ÈÅì‰∫Ü'),
                          ),
                        ],
                      ),
                    );
                  } else {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: const Text('ÁõÆÂΩïËÆæÁΩÆÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ë∑ØÂæÑÊòØÂê¶Ê≠£Á°Æ'),
                        backgroundColor: Theme.of(context).colorScheme.error,
                      ),
                    );
                  }
                }
              },
              child: const Text('‰øùÂ≠ò'),
            ),
          ],
        ),
      ),
    );
  }

  /// Á°ÆËÆ§Ê∏ÖÈô§ÁºìÂ≠ò
  Future<void> _confirmClearCache() async {
    final stats = await CacheService().getCacheStats();

    if (stats.totalFiles == 0) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ÊöÇÊó†ÁºìÂ≠òÂèØÊ∏ÖÈô§')),
        );
      }
      return;
    }

    if (!mounted) return;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Ê∏ÖÈô§ÁºìÂ≠ò'),
        content: Text(
          'Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÂêóÔºü\n\n'
          'Â∞ÜÂà†Èô§ ${stats.totalFiles} È¶ñÊ≠åÊõ≤ÁöÑÁºìÂ≠ò\n'
          'ÈáäÊîæ ${stats.formattedSize} Á©∫Èó¥',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂèñÊ∂à'),
          ),
          FilledButton(
            onPressed: () async {
              Navigator.pop(context);
              
              // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
              if (mounted) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Row(
                      children: [
                        SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: Colors.white,
                          ),
                        ),
                        SizedBox(width: 16),
                        Text('Ê≠£Âú®Ê∏ÖÈô§ÁºìÂ≠ò...'),
                      ],
                    ),
                    duration: Duration(seconds: 3),
                  ),
                );
              }

              // Ê∏ÖÈô§ÁºìÂ≠ò
              await CacheService().clearAllCache();

              // ÊòæÁ§∫ÂÆåÊàêÊèêÁ§∫
              if (mounted) {
                ScaffoldMessenger.of(context).hideCurrentSnackBar();
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('Â∑≤Ê∏ÖÈô§ ${stats.totalFiles} È¶ñÊ≠åÊõ≤ÁöÑÁºìÂ≠ò'),
                    backgroundColor: Colors.green,
                  ),
                );
              }
            },
            style: FilledButton.styleFrom(
              backgroundColor: Theme.of(context).colorScheme.error,
            ),
            child: const Text('Ê∏ÖÈô§'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫‰∏ãËΩΩÁõÆÂΩïËÆæÁΩÆ
  Future<void> _showDownloadDirSettings() async {
    final currentDownloadPath = DownloadService().downloadPath;
    final dirController = TextEditingController(text: currentDownloadPath ?? '');

    if (!mounted) return;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('‰∏ãËΩΩÁõÆÂΩïËÆæÁΩÆ'),
        content: SizedBox(
          width: 500,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'ÂΩìÂâç‰∏ãËΩΩÁõÆÂΩïÔºö',
                style: Theme.of(context).textTheme.titleSmall,
              ),
              const SizedBox(height: 8),
              Text(
                currentDownloadPath ?? 'Êú™ËÆæÁΩÆ',
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: Theme.of(context).colorScheme.onSurfaceVariant,
                    ),
              ),
              const SizedBox(height: 24),
              TextField(
                controller: dirController,
                decoration: const InputDecoration(
                  labelText: 'Êñ∞‰∏ãËΩΩÁõÆÂΩï',
                  border: OutlineInputBorder(),
                  hintText: '‰æãÂ¶Ç: D:\\Music\\Cyrene',
                ),
                readOnly: true,
              ),
              const SizedBox(height: 16),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton.icon(
                      onPressed: () async {
                        final result = await FilePicker.platform.getDirectoryPath(
                          dialogTitle: 'ÈÄâÊã©‰∏ãËΩΩÁõÆÂΩï',
                        );

                        if (result != null) {
                          dirController.text = result;
                        }
                      },
                      icon: const Icon(Icons.folder_open),
                      label: const Text('ÊµèËßà'),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Theme.of(context).colorScheme.secondaryContainer,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    Icon(
                      Icons.info_outline,
                      size: 20,
                      color: Theme.of(context).colorScheme.onSecondaryContainer,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        '‰∏ãËΩΩÁöÑÈü≥‰πêÊñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ÊåáÂÆöÁõÆÂΩï',
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                              color: Theme.of(context).colorScheme.onSecondaryContainer,
                            ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂèñÊ∂à'),
          ),
          FilledButton(
            onPressed: () async {
              final newDir = dirController.text.trim();

              if (newDir.isEmpty) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('ËØ∑ÈÄâÊã©‰∏ãËΩΩÁõÆÂΩï')),
                );
                return;
              }

              // ËÆæÁΩÆÊñ∞ÁöÑ‰∏ãËΩΩÁõÆÂΩï
              final success = await DownloadService().setDownloadPath(newDir);

              if (mounted) {
                Navigator.pop(context);
                if (success) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('‰∏ãËΩΩÁõÆÂΩïÂ∑≤Êõ¥Êñ∞')),
                  );
                } else {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('ËÆæÁΩÆ‰∏ãËΩΩÁõÆÂΩïÂ§±Ë¥•')),
                  );
                }
              }
            },
            child: const Text('‰øùÂ≠ò'),
          ),
        ],
      ),
    );
  }

  /// ÊòæÁ§∫Êí≠ÊîæÂô®ËÉåÊôØËÆæÁΩÆÂØπËØùÊ°Ü
  void _showPlayerBackgroundDialog() {
    showDialog(
      context: context,
      builder: (context) => _PlayerBackgroundDialog(
        onChanged: () {
          // ÂΩìÂØπËØùÊ°ÜÂÜÖÁöÑËÆæÁΩÆÊîπÂèòÊó∂ÔºåÂà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢
          if (mounted) {
            setState(() {});
          }
        },
      ),
    );
  }
}

/// Êí≠ÊîæÂô®ËÉåÊôØËÆæÁΩÆÂØπËØùÊ°Ü
class _PlayerBackgroundDialog extends StatefulWidget {
  final VoidCallback onChanged;
  
  const _PlayerBackgroundDialog({required this.onChanged});

  @override
  State<_PlayerBackgroundDialog> createState() => _PlayerBackgroundDialogState();
}

class _PlayerBackgroundDialogState extends State<_PlayerBackgroundDialog> {
  @override
  Widget build(BuildContext context) {
    final backgroundService = PlayerBackgroundService();
    final currentType = backgroundService.backgroundType;

    return AlertDialog(
      title: const Row(
        children: [
          Icon(Icons.wallpaper),
          SizedBox(width: 8),
          Text('Êí≠ÊîæÂô®ËÉåÊôØËÆæÁΩÆ'),
        ],
      ),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Ëá™ÈÄÇÂ∫îËÉåÊôØ
            RadioListTile<PlayerBackgroundType>(
              title: const Text('Ëá™ÈÄÇÂ∫îËÉåÊôØ'),
              subtitle: const Text('Âü∫‰∫é‰∏ìËæëÂ∞ÅÈù¢ÊèêÂèñÈ¢úËâ≤'),
              value: PlayerBackgroundType.adaptive,
              groupValue: currentType,
              onChanged: (value) async {
                await backgroundService.setBackgroundType(value!);
                setState(() {});
                widget.onChanged();
              },
            ),
            
            // Á∫ØËâ≤ËÉåÊôØ
            RadioListTile<PlayerBackgroundType>(
              title: const Text('Á∫ØËâ≤ËÉåÊôØ'),
              subtitle: const Text('‰ΩøÁî®Ëá™ÂÆö‰πâÁ∫ØËâ≤'),
              value: PlayerBackgroundType.solidColor,
              groupValue: currentType,
              onChanged: (value) async {
                await backgroundService.setBackgroundType(value!);
                setState(() {});
                widget.onChanged();
              },
            ),
            
            // Á∫ØËâ≤ÈÄâÊã©Âô®Ôºà‰ªÖÂú®ÈÄâÊã©Á∫ØËâ≤Êó∂ÊòæÁ§∫Ôºâ
            if (currentType == PlayerBackgroundType.solidColor) ...[
              const SizedBox(height: 8),
              Padding(
                padding: const EdgeInsets.only(left: 16),
                child: OutlinedButton.icon(
                  onPressed: _showSolidColorPicker,
                  icon: Icon(
                    Icons.palette,
                    color: backgroundService.solidColor,
                  ),
                  label: const Text('ÈÄâÊã©È¢úËâ≤'),
                ),
              ),
            ],
            
            const SizedBox(height: 8),
            
            // ÂõæÁâáËÉåÊôØ
            RadioListTile<PlayerBackgroundType>(
              title: const Text('ÂõæÁâáËÉåÊôØ'),
              subtitle: Text(
                backgroundService.imagePath != null
                    ? 'Â∑≤ËÆæÁΩÆËá™ÂÆö‰πâÂõæÁâá'
                    : 'Êú™ËÆæÁΩÆÂõæÁâá',
              ),
              value: PlayerBackgroundType.image,
              groupValue: currentType,
              onChanged: (value) async {
                await backgroundService.setBackgroundType(value!);
                setState(() {});
                widget.onChanged();
              },
            ),
                
            // ÂõæÁâáÈÄâÊã©ÂíåÊ®°Á≥äËÆæÁΩÆÔºà‰ªÖÂú®ÈÄâÊã©ÂõæÁâáËÉåÊôØÊó∂ÊòæÁ§∫Ôºâ
            if (currentType == PlayerBackgroundType.image) ...[
              const SizedBox(height: 8),
              Padding(
                padding: const EdgeInsets.only(left: 16, right: 16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // ÈÄâÊã©ÂõæÁâáÊåâÈíÆ
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton.icon(
                            onPressed: _selectBackgroundImage,
                            icon: const Icon(Icons.image),
                            label: const Text('ÈÄâÊã©ÂõæÁâá'),
                          ),
                        ),
                        if (backgroundService.imagePath != null) ...[
                          const SizedBox(width: 8),
                          IconButton(
                            onPressed: () async {
                              await backgroundService.clearImageBackground();
                              setState(() {});
                              widget.onChanged();
                            },
                            icon: const Icon(Icons.clear),
                            tooltip: 'Ê∏ÖÈô§ÂõæÁâá',
                          ),
                        ],
                      ],
                    ),
                    
                    const SizedBox(height: 16),
                    
                    // Ê®°Á≥äÁ®ãÂ∫¶Ë∞ÉËäÇ
                    Text(
                      'Ê®°Á≥äÁ®ãÂ∫¶: ${backgroundService.blurAmount.toStringAsFixed(0)}',
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                    Slider(
                      value: backgroundService.blurAmount,
                      min: 0,
                      max: 50,
                      divisions: 50,
                      label: backgroundService.blurAmount.toStringAsFixed(0),
                      onChanged: (value) async {
                        await backgroundService.setBlurAmount(value);
                        setState(() {});
                        widget.onChanged();
                      },
                    ),
                    Text(
                      '0 = Ê∏ÖÊô∞Ôºå50 = ÊúÄÊ®°Á≥ä',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: Theme.of(context).colorScheme.onSurfaceVariant,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('ÂÖ≥Èó≠'),
        ),
      ],
    );
  }

  /// ÊòæÁ§∫Á∫ØËâ≤ÈÄâÊã©Âô®
  Future<void> _showSolidColorPicker() async {
    final backgroundService = PlayerBackgroundService();
    Color? selectedColor;

    await showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ÈÄâÊã©Á∫ØËâ≤'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // È¢ÑËÆæÈ¢úËâ≤
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: [
                  Colors.grey[900]!,
                  Colors.black,
                  Colors.blue[900]!,
                  Colors.purple[900]!,
                  Colors.red[900]!,
                  Colors.green[900]!,
                  Colors.orange[900]!,
                  Colors.teal[900]!,
                ].map((color) => InkWell(
                  onTap: () {
                    selectedColor = color;
                    Navigator.pop(context);
                  },
                  child: Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      color: color,
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: color == backgroundService.solidColor
                            ? Theme.of(context).colorScheme.primary
                            : Colors.transparent,
                        width: 3,
                      ),
                    ),
                  ),
                )).toList(),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ÂèñÊ∂à'),
          ),
        ],
      ),
    );

    if (selectedColor != null) {
      await backgroundService.setSolidColor(selectedColor!);
      setState(() {});
      widget.onChanged();
    }
  }

  /// ÈÄâÊã©ËÉåÊôØÂõæÁâá
  Future<void> _selectBackgroundImage() async {
    final result = await FilePicker.platform.pickFiles(
      type: FileType.image,
      dialogTitle: 'ÈÄâÊã©ËÉåÊôØÂõæÁâá',
    );

    if (result != null && result.files.single.path != null) {
      final imagePath = result.files.single.path!;
      await PlayerBackgroundService().setImageBackground(imagePath);
      setState(() {});
      widget.onChanged();
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('ËÉåÊôØÂõæÁâáÂ∑≤ËÆæÁΩÆ'),
            duration: Duration(seconds: 2),
          ),
        );
      }
    }
  }
}
