# 缓存功能 v1.3.3 更新

## 🎯 本次更新

### 1. 可视化目录选择器 📁

**之前：** 手动输入目录路径
```
┌─────────────────────────────┐
│ 自定义目录                   │
│ D:\Music\Cache              │
└─────────────────────────────┘
```

**现在：** 点击按钮浏览选择
```
┌─────────────────────────────┬────┐
│ 自定义目录                   │ 📂 │
│ D:\Music\Cache              │    │
└─────────────────────────────┴────┘
       ↑ 输入框              ↑ 浏览按钮
```

**改进：**
- ✅ 添加文件夹图标按钮
- ✅ 点击打开系统目录选择器
- ✅ 选择后自动填入路径
- ✅ 仍可手动输入路径

### 2. 歌词缓存功能 📝

**问题：** 使用缓存播放时没有歌词

**原因：** 缓存时未保存歌词数据

**修复：**
- ✅ 缓存元数据中添加歌词字段
- ✅ 缓存时保存原文和翻译
- ✅ 播放时从元数据恢复歌词
- ✅ 完美支持歌词显示

---

## 🔧 技术实现

### 元数据扩展

**新增字段：**
```dart
class CacheMetadata {
  final String album;      // 专辑名称
  final String picUrl;     // 封面图片
  final String lyric;      // 原文歌词
  final String tlyric;     // 翻译歌词
  // ... 其他字段
}
```

**缓存时保存：**
```dart
final metadata = CacheMetadata(
  // ...
  lyric: songDetail.lyric,      // 保存歌词
  tlyric: songDetail.tlyric,    // 保存翻译
);
```

**播放时恢复：**
```dart
_currentSong = SongDetail(
  // ...
  lyric: metadata.lyric,      // 恢复歌词
  tlyric: metadata.tlyric,    // 恢复翻译
);
```

### 目录选择器实现

**新增依赖：**
```yaml
file_picker: ^8.0.0
```

**UI 实现：**
```dart
IconButton.filledTonal(
  onPressed: () async {
    // 打开系统目录选择器
    String? selectedDirectory = await FilePicker.platform.getDirectoryPath(
      dialogTitle: '选择缓存目录',
      lockParentWindow: true,
    );
    
    if (selectedDirectory != null) {
      dirController.text = selectedDirectory;
    }
  },
  icon: const Icon(Icons.folder_open),
  tooltip: '浏览选择目录',
)
```

---

## 🎨 界面改进

### 缓存目录设置对话框

```
┌──────────────────────────────────────────┐
│ 📁 缓存目录设置                           │
├──────────────────────────────────────────┤
│ 当前目录：                               │
│ D:\work\...\Release\music_cache          │
│                                          │
│ ─────────────────────────────────────    │
│                                          │
│ 默认目录：                               │
│ D:\work\...\Release\music_cache          │
│                                          │
│ ┌────────────────────────────────┐ ┌──┐ │
│ │ 📝 自定义目录（留空使用默认）  │ │📂│ │ ← 新增浏览按钮
│ │ D:\Music\Cache                │ └──┘ │
│ └────────────────────────────────┘      │
│                                          │
│ ℹ️ 提示                                  │
│ • 点击文件夹图标选择目录                 │
│ • 更改目录需要重启应用生效               │
│ • 确保目录有读写权限                     │
│ • 旧缓存不会自动迁移                     │
└──────────────────────────────────────────┘
  [恢复默认]  [取消]  [保存]
```

---

## 📝 使用方法

### 选择自定义目录

**方法 1：浏览选择（推荐）**
1. 打开设置 → 存储 → 缓存目录
2. 点击输入框右侧的 📂 **文件夹图标**
3. 系统目录选择器打开
4. 浏览并选择目录
5. 路径自动填入
6. 点击「保存」
7. 重启应用生效

**方法 2：手动输入**
1. 打开设置 → 存储 → 缓存目录
2. 在输入框中直接输入路径
3. 点击「保存」
4. 重启应用生效

### 验证歌词恢复

**测试步骤：**
1. 播放一首有歌词的歌曲
2. 等待缓存完成
3. 关闭应用
4. 重新打开应用
5. 再次播放同一首歌
6. 检查播放器页面
7. 歌词应该正常显示 ✅

---

## 🐛 问题修复

### 问题：缓存播放无歌词

**现象：**
- 首次播放：歌词正常显示
- 使用缓存播放：歌词消失

**原因：**
```dart
// 之前的代码
_currentSong = SongDetail(
  lyric: '',      // ❌ 空字符串
  tlyric: '',     // ❌ 空字符串
);
```

**修复：**
```dart
// 现在的代码
final metadata = CacheService().getCachedMetadata(track);
_currentSong = SongDetail(
  lyric: metadata.lyric,      // ✅ 从缓存恢复
  tlyric: metadata.tlyric,    // ✅ 从缓存恢复
);
```

**结果：**
- ✅ 缓存播放时歌词正常显示
- ✅ 包括原文和翻译
- ✅ 与首次播放体验一致

---

## 📊 文件大小影响

### 元数据大小变化

**之前：** ~200 bytes
```json
{
  "songId": "123456",
  "songName": "演员",
  "artists": "薛之谦",
  "source": "netease",
  "quality": "exhigh",
  "originalUrl": "...",
  "fileSize": 5242880,
  "cachedAt": "...",
  "checksum": "..."
}
```

**现在：** ~2-5 KB（包含歌词）
```json
{
  // ... 原有字段
  "album": "...",
  "picUrl": "...",
  "lyric": "[00:00.000]...[03:45.123]...",    // 原文歌词
  "tlyric": "[00:00.000]...[03:45.123]..."   // 翻译歌词
}
```

**影响：**
- 每首歌元数据增加约 2-5 KB
- 相比音频文件（5-30 MB）可忽略
- 换来完整的播放体验

---

## ✨ 完整流程

### 缓存歌曲（保存歌词）

```
播放歌曲
  ↓
从网络获取 SongDetail
  ↓
包含：音频 URL + 歌词 + 翻译
  ↓
下载音频数据
  ↓
创建元数据（包含歌词）
  ↓
加密并保存到 .cyrene 文件
  ↓
缓存完成 ✅
```

### 使用缓存（恢复歌词）

```
播放歌曲
  ↓
检查缓存（有）
  ↓
获取元数据
  ↓
从元数据恢复：
  - 歌曲信息
  - 专辑封面
  - 歌词
  - 翻译
  ↓
解密音频文件
  ↓
创建完整的 SongDetail
  ↓
播放 + 显示歌词 ✅
```

---

## 🎯 测试建议

### 测试 1：目录选择器

1. 打开设置 → 存储 → 缓存目录
2. 点击输入框右侧的 📂 图标
3. 系统目录选择器应该打开
4. 选择任意目录（如 `D:\Test`）
5. 路径自动填入输入框
6. 点击保存
7. 重启应用验证

### 测试 2：歌词恢复

1. 播放一首有歌词的歌曲（网易云）
2. 确认歌词正常显示
3. 等待缓存完成（约 10 秒）
4. 重新播放同一首歌
5. 应该立即播放（使用缓存）
6. **检查歌词是否显示** ✅
7. 检查翻译是否显示 ✅

### 测试 3：完整缓存信息

播放并缓存后，检查元数据是否完整：
- ✅ 歌曲基本信息
- ✅ 专辑名称
- ✅ 封面图片 URL
- ✅ 原文歌词
- ✅ 翻译歌词
- ✅ 音质等级

---

## 📚 更新的文件

### 核心代码

1. **lib/services/cache_service.dart**
   - ✅ 扩展 `CacheMetadata` 模型
   - ✅ 添加 `album`、`picUrl`、`lyric`、`tlyric` 字段
   - ✅ 新增 `getCachedMetadata()` 方法

2. **lib/services/player_service.dart**
   - ✅ 修复缓存播放逻辑
   - ✅ 从元数据恢复歌词
   - ✅ 添加歌词恢复日志

3. **lib/pages/settings_page.dart**
   - ✅ 添加目录选择器按钮
   - ✅ 集成 FilePicker
   - ✅ 改进对话框布局

### 依赖

4. **pubspec.yaml**
   - ✅ 添加 `file_picker: ^8.0.0`

---

## 🎉 功能对比

### 之前 vs 现在

| 功能 | v1.3.2 | v1.3.3 |
|------|--------|--------|
| 目录设置 | ⌨️ 手动输入 | 📂 可视化选择 |
| 缓存歌词 | ❌ 不保存 | ✅ 保存歌词 |
| 歌词显示 | ❌ 缓存播放无歌词 | ✅ 完整显示 |
| 用户体验 | ⚠️ 需记忆路径 | ✅ 可浏览选择 |

---

## 📝 日志示例

### 缓存时（保存歌词）

```
💾 [CacheService] 开始缓存: 演员 (网易云音乐)
📥 [CacheService] 下载完成: 5242880 bytes
🔒 [CacheService] 保存缓存文件
📊 [CacheService] 文件大小: 5245123 bytes (元数据: 2243 bytes)
✅ [CacheService] 缓存完成: 演员
```

### 播放时（恢复歌词）

```
💾 [PlayerService] 使用缓存播放
✅ [CacheService] 解密缓存文件
✅ [PlayerService] 从缓存播放
📝 [PlayerService] 歌词已从缓存恢复
```

---

## 🚀 快速验证

### 步骤 1：安装依赖

```bash
flutter pub get
```

### 步骤 2：运行应用

```bash
flutter run
```

### 步骤 3：测试目录选择器

1. 设置 → 存储 → 缓存目录
2. 点击输入框右侧的 📂 图标
3. 系统文件选择器打开
4. 选择目录（如 `D:\MusicCache`）
5. 路径自动填入
6. 保存

### 步骤 4：测试歌词

1. 播放有歌词的歌曲
2. 确认歌词显示
3. 等待缓存完成
4. 重新播放
5. **验证歌词仍然显示** ✅

---

## 📋 改进清单

✅ **已实现：**
- [x] 可视化目录选择器
- [x] 缓存歌词数据
- [x] 恢复歌词显示
- [x] 缓存专辑和封面信息
- [x] 完整的元数据支持

✅ **用户体验提升：**
- [x] 不需要记忆路径
- [x] 可浏览文件夹选择
- [x] 缓存播放体验与首次一致
- [x] 歌词完整显示

---

## 🎯 完整功能列表

### 缓存设置

1. **缓存开关** 🔧
   - 一键启用/禁用
   - 实时生效

2. **缓存目录** 📁
   - 查看当前目录
   - 查看默认目录
   - 可视化选择目录 🆕
   - 手动输入目录
   - 恢复默认目录

3. **缓存管理** 📊
   - 查看统计信息
   - 各平台歌曲数
   - 占用空间

4. **清除缓存** 🗑️
   - 一键清除所有缓存
   - 释放存储空间

### 缓存内容

保存的完整信息：
- ✅ 歌曲 ID 和名称
- ✅ 艺术家和专辑
- ✅ 封面图片 URL
- ✅ 音乐来源
- ✅ 音质等级
- ✅ **原文歌词** 🆕
- ✅ **翻译歌词** 🆕
- ✅ 加密的音频数据
- ✅ 校验和

---

## 📚 文档

- **[CACHE_SETTINGS.md](docs/CACHE_SETTINGS.md)** - 设置功能说明
- **[CACHE_QUICK_GUIDE.md](docs/CACHE_QUICK_GUIDE.md)** - 快速使用指南
- **[CYRENE_FILE_FORMAT.md](docs/CYRENE_FILE_FORMAT.md)** - 文件格式
- **[MUSIC_CACHE.md](docs/MUSIC_CACHE.md)** - 功能总览

---

## ✅ 版本总结

**版本：** v1.3.3  
**日期：** 2025-10-02  

**新增功能：**
1. ✅ 可视化目录选择器
2. ✅ 缓存歌词支持

**改进：**
- 🎯 更友好的用户界面
- 📝 完整的缓存数据
- 🎵 一致的播放体验

**技术：**
- 📦 新增 file_picker 依赖
- 🔧 扩展缓存元数据模型
- 💾 完善缓存恢复逻辑

---

**测试状态：** ✅ 无错误  
**文档状态：** ✅ 已更新  
**建议操作：** 运行 `flutter pub get` 安装新依赖

