# æ•°æ®æŒä¹…åŒ–åŠŸèƒ½è¯´æ˜

## ğŸ“ æ¦‚è¿°

å·²ä¸º Cyrene Music æ·»åŠ å®Œæ•´çš„æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ï¼Œä½¿ç”¨ `shared_preferences` åŒ…æ¥ä¿å­˜ç”¨æˆ·è®¾ç½®å’Œç™»å½•çŠ¶æ€ã€‚ç°åœ¨åº”ç”¨é‡å¯åä¼šè‡ªåŠ¨æ¢å¤æ‰€æœ‰è®¾ç½®ã€‚

## âœ… å·²å®ç°çš„æŒä¹…åŒ–åŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯çŠ¶æ€ (AuthService)

**ä¿å­˜çš„æ•°æ®**:
- âœ… ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€ID ç­‰ï¼‰
- âœ… ç™»å½•çŠ¶æ€

**å­˜å‚¨é”®å**:
- `current_user` - ç”¨æˆ·ä¿¡æ¯ JSON å­—ç¬¦ä¸²

**è¡Œä¸º**:
- ç™»å½•æˆåŠŸæ—¶è‡ªåŠ¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯
- é€€å‡ºç™»å½•æ—¶è‡ªåŠ¨æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€

### 2. ä¸»é¢˜è®¾ç½® (ThemeManager)

**ä¿å­˜çš„æ•°æ®**:
- âœ… ä¸»é¢˜æ¨¡å¼ï¼ˆæµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿï¼‰
- âœ… ä¸»é¢˜è‰²ï¼ˆè‡ªå®šä¹‰é¢œè‰²ï¼‰

**å­˜å‚¨é”®å**:
- `theme_mode` - ä¸»é¢˜æ¨¡å¼ç´¢å¼• (0=light, 1=dark, 2=system)
- `seed_color` - ä¸»é¢˜è‰²å€¼ (int)

**è¡Œä¸º**:
- åˆ‡æ¢ä¸»é¢˜æ¨¡å¼æ—¶è‡ªåŠ¨ä¿å­˜
- æ›´æ”¹ä¸»é¢˜è‰²æ—¶è‡ªåŠ¨ä¿å­˜
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ä¸»é¢˜è®¾ç½®

### 3. åç«¯æºé…ç½® (UrlService)

**ä¿å­˜çš„æ•°æ®**:
- âœ… åç«¯æºç±»å‹ï¼ˆå®˜æ–¹æº/è‡ªå®šä¹‰æºï¼‰
- âœ… è‡ªå®šä¹‰åç«¯åœ°å€

**å­˜å‚¨é”®å**:
- `backend_source_type` - æºç±»å‹ç´¢å¼• (0=official, 1=custom)
- `custom_base_url` - è‡ªå®šä¹‰æºåœ°å€å­—ç¬¦ä¸²

**è¡Œä¸º**:
- åˆ‡æ¢åç«¯æºæ—¶è‡ªåŠ¨ä¿å­˜
- è®¾ç½®è‡ªå®šä¹‰åœ°å€æ—¶è‡ªåŠ¨ä¿å­˜
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤åç«¯é…ç½®

### 4. å¸ƒå±€åå¥½ (LayoutPreferenceService)

**ä¿å­˜çš„æ•°æ®**:
- âœ… å¸ƒå±€æ¨¡å¼ï¼ˆæ¡Œé¢æ¨¡å¼/ç§»åŠ¨æ¨¡å¼ï¼‰- ä»… Windows å¹³å°

**å­˜å‚¨é”®å**:
- `layout_mode` - å¸ƒå±€æ¨¡å¼ç´¢å¼• (0=desktop, 1=mobile)

**è¡Œä¸º**:
- åˆ‡æ¢å¸ƒå±€æ¨¡å¼æ—¶è‡ªåŠ¨ä¿å­˜
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤å¸ƒå±€è®¾ç½®
- è‡ªåŠ¨è°ƒæ•´çª—å£å¤§å°

## ğŸ”§ æŠ€æœ¯å®ç°

### ä½¿ç”¨çš„åŒ…
```yaml
shared_preferences: ^2.3.3
```

### æ”¯æŒçš„å¹³å°
- âœ… Windows
- âœ… Android
- âœ… iOS
- âœ… macOS
- âœ… Linux
- âœ… Web

### æ•°æ®å­˜å‚¨ä½ç½®

**Windows**:
- `%APPDATA%\Roaming\cyrene_music\shared_preferences\`

**Android**:
- `SharedPreferences` (ç³»ç»Ÿé»˜è®¤ä½ç½®)

**iOS/macOS**:
- `NSUserDefaults`

**Linux**:
- `~/.local/share/cyrene_music/`

**Web**:
- `LocalStorage`

## ğŸ“Š å­˜å‚¨çš„æ•°æ®ç¤ºä¾‹

```json
{
  "current_user": "{\"id\":1,\"email\":\"user@example.com\",\"username\":\"å¼ ä¸‰\",\"isVerified\":true}",
  "theme_mode": 1,
  "seed_color": 4288423856,
  "backend_source_type": 0,
  "custom_base_url": "",
  "layout_mode": 0
}
```

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### ä½œä¸ºç”¨æˆ·

æ— éœ€ä»»ä½•æ“ä½œï¼æ‰€æœ‰è®¾ç½®éƒ½ä¼š**è‡ªåŠ¨ä¿å­˜**å’Œ**è‡ªåŠ¨æ¢å¤**ï¼š

1. **ç™»å½•è´¦å·** â†’ ä¸‹æ¬¡å¯åŠ¨è‡ªåŠ¨ç™»å½•
2. **åˆ‡æ¢ä¸»é¢˜** â†’ ä¸‹æ¬¡å¯åŠ¨ä¿æŒä¸»é¢˜
3. **æ›´æ”¹åç«¯æº** â†’ ä¸‹æ¬¡å¯åŠ¨ä¿æŒé…ç½®
4. **åˆ‡æ¢å¸ƒå±€æ¨¡å¼** â†’ ä¸‹æ¬¡å¯åŠ¨ä¿æŒå¸ƒå±€

### ä½œä¸ºå¼€å‘è€…

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„æŒä¹…åŒ–æ•°æ®ï¼š

```dart
// 1. å¯¼å…¥ shared_preferences
import 'package:shared_preferences/shared_preferences.dart';

// 2. åœ¨æœåŠ¡çš„æ„é€ å‡½æ•°ä¸­åŠ è½½æ•°æ®
MyService._internal() {
  _loadSettings();
}

// 3. å®ç°åŠ è½½æ–¹æ³•
Future<void> _loadSettings() async {
  final prefs = await SharedPreferences.getInstance();
  _myValue = prefs.getString('my_key') ?? 'default';
  notifyListeners();
}

// 4. å®ç°ä¿å­˜æ–¹æ³•
Future<void> _saveSettings() async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.setString('my_key', _myValue);
}

// 5. åœ¨æ•°æ®å˜åŒ–æ—¶è°ƒç”¨ä¿å­˜
void setMyValue(String value) {
  _myValue = value;
  _saveSettings();
  notifyListeners();
}
```

## ğŸ—‘ï¸ æ¸…é™¤æ•°æ®

å¦‚æœéœ€è¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ•°æ®ï¼š

### æ–¹æ³•1: é€šè¿‡ä»£ç 

```dart
final prefs = await SharedPreferences.getInstance();
await prefs.clear(); // æ¸…é™¤æ‰€æœ‰æ•°æ®
```

### æ–¹æ³•2: æ‰‹åŠ¨åˆ é™¤æ–‡ä»¶

**Windows**: åˆ é™¤ `%APPDATA%\Roaming\cyrene_music\` æ–‡ä»¶å¤¹

**Android**: åœ¨è®¾ç½®ä¸­æ¸…é™¤åº”ç”¨æ•°æ®

**Linux**: åˆ é™¤ `~/.local/share/cyrene_music/` æ–‡ä»¶å¤¹

## ğŸ› è°ƒè¯•æ—¥å¿—

åº”ç”¨ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„æŒä¹…åŒ–æ—¥å¿—ï¼š

```
ğŸ‘¤ [AuthService] ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·: å¼ ä¸‰
ğŸ¨ [ThemeManager] ä»æœ¬åœ°åŠ è½½ä¸»é¢˜: dark, ä¸»é¢˜è‰²: 0xff9c27b0
ğŸŒ [UrlService] ä»æœ¬åœ°åŠ è½½é…ç½®: official, è‡ªå®šä¹‰æº: 
ğŸ–¥ï¸ [LayoutPreference] ä»æœ¬åœ°åŠ è½½å¸ƒå±€: desktop
ğŸ’¾ [AuthService] ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°æœ¬åœ°
ğŸ’¾ [ThemeManager] ä¸»é¢˜æ¨¡å¼å·²ä¿å­˜: dark
ğŸ’¾ [UrlService] æºç±»å‹å·²ä¿å­˜: custom
ğŸ’¾ [LayoutPreference] å¸ƒå±€æ¨¡å¼å·²ä¿å­˜: mobile
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

- âœ… æ•°æ®åŠ è½½æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡ UI
- âœ… åªåœ¨æ•°æ®å˜åŒ–æ—¶ä¿å­˜ï¼Œé¿å…ä¸å¿…è¦çš„ I/O
- âœ… ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- âœ… æ‰€æœ‰æœåŠ¡åœ¨æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨åŠ è½½æ•°æ®

## ğŸ” æ•°æ®å®‰å…¨

**æ³¨æ„**: `shared_preferences` ä»¥**æ˜æ–‡**æ–¹å¼å­˜å‚¨æ•°æ®ï¼Œä¸é€‚åˆå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€Tokenï¼‰ã€‚

å½“å‰å­˜å‚¨çš„æ•°æ®éƒ½æ˜¯éæ•æ„Ÿä¿¡æ¯ï¼š
- âœ… ç”¨æˆ·åã€é‚®ç®±ï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
- âœ… ä¸»é¢˜è®¾ç½®ï¼ˆUI åå¥½ï¼‰
- âœ… åç«¯æºåœ°å€ï¼ˆé…ç½®ä¿¡æ¯ï¼‰

**å¦‚éœ€å­˜å‚¨æ•æ„Ÿæ•°æ®**ï¼Œå»ºè®®ä½¿ç”¨ï¼š
- `flutter_secure_storage` - åŠ å¯†å­˜å‚¨
- `hive` + åŠ å¯† - æœ¬åœ°æ•°æ®åº“åŠ å¯†

## ğŸ“š ç›¸å…³èµ„æº

- [shared_preferences å®˜æ–¹æ–‡æ¡£](https://pub.dev/packages/shared_preferences)
- [Flutter æ•°æ®æŒä¹…åŒ–æŒ‡å—](https://docs.flutter.dev/cookbook/persistence)

## âœ¨ æ›´æ–°æ—¥å¿—

**2025-10-01**:
- âœ… æ·»åŠ ç”¨æˆ·ç™»å½•çŠ¶æ€æŒä¹…åŒ–
- âœ… æ·»åŠ ä¸»é¢˜è®¾ç½®æŒä¹…åŒ–
- âœ… æ·»åŠ åç«¯æºé…ç½®æŒä¹…åŒ–
- âœ… æ·»åŠ å¸ƒå±€åå¥½æŒä¹…åŒ–
- âœ… æ‰€æœ‰è®¾ç½®æ”¯æŒè·¨å¹³å°è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤

