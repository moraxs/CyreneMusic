# ç¼“å­˜åŠŸèƒ½æ›´æ–° v1.3.1

## ğŸ¯ æœ¬æ¬¡æ›´æ–°å†…å®¹

### 1. Windows å¹³å°ç¼“å­˜ä½ç½®è°ƒæ•´

**ä¹‹å‰ï¼š**
```
C:\Users\{ç”¨æˆ·å}\Documents\music_cache\
```

**ç°åœ¨ï¼š**
```
{åº”ç”¨è¿è¡Œç›®å½•}\music_cache\

å¼€å‘ç¯å¢ƒç¤ºä¾‹ï¼š
D:\work\cyrene_music\build\windows\x64\runner\Release\music_cache\

å‘å¸ƒç‰ˆæœ¬ç¤ºä¾‹ï¼š
C:\Program Files\Cyrene Music\music_cache\
```

**ä¼˜åŠ¿ï¼š**
- âœ… **ä¾¿äºæŸ¥æ‰¾** - ç¼“å­˜å’Œåº”ç”¨åœ¨åŒä¸€ç›®å½•
- âœ… **ä¾¿äºå¤‡ä»½** - ç›´æ¥å¤‡ä»½æ•´ä¸ªåº”ç”¨ç›®å½•
- âœ… **ä¾¿äºç§»æ¤** - å¤åˆ¶åº”ç”¨ç›®å½•å³å¯è¿ç§»ç¼“å­˜
- âœ… **ä¾¿äºç®¡ç†** - ä¸æ±¡æŸ“ç”¨æˆ·æ–‡æ¡£ç›®å½•

### 2. ç´¢å¼•æ–‡ä»¶åŠ å¯†

**ä¹‹å‰ï¼š**
```
cache_index.json ï¼ˆæ˜æ–‡ï¼‰
```

**ç°åœ¨ï¼š**
```
cache_index.cyrene ï¼ˆåŠ å¯†ï¼‰
```

**æ”¹è¿›ï¼š**
- âœ… **ç»Ÿä¸€æ ¼å¼** - æ‰€æœ‰æ–‡ä»¶éƒ½ä½¿ç”¨ `.cyrene` æ‰©å±•å
- âœ… **å®‰å…¨ä¿æŠ¤** - ç´¢å¼•æ–‡ä»¶ä¹Ÿç»è¿‡åŠ å¯†
- âœ… **é˜²æ­¢ç¯¡æ”¹** - æ— æ³•ç›´æ¥ç¼–è¾‘ç´¢å¼•æ–‡ä»¶

---

## ğŸ“ æ–°çš„æ–‡ä»¶ç»“æ„

### Windows å¼€å‘ç¯å¢ƒ

```
D:\work\cyrene_music\build\windows\x64\runner\Release\
â”œâ”€â”€ cyrene_music.exe
â”œâ”€â”€ music_cache\                      â¬…ï¸ ç¼“å­˜ç›®å½•
â”‚   â”œâ”€â”€ cache_index.cyrene            â¬…ï¸ åŠ å¯†çš„ç´¢å¼•
â”‚   â”œâ”€â”€ netease_123456.cyrene         â¬…ï¸ æ­Œæ›²ç¼“å­˜
â”‚   â”œâ”€â”€ qq_789012.cyrene
â”‚   â””â”€â”€ kugou_345678.cyrene
â””â”€â”€ data\...
```

### å…¶ä»–å¹³å°

å…¶ä»–å¹³å°ï¼ˆAndroidã€macOSã€Linuxï¼‰ç»§ç»­ä½¿ç”¨åº”ç”¨æ•°æ®ç›®å½•ã€‚

---

## ğŸ”’ åŠ å¯†è¯¦æƒ…

### ç¼“å­˜ç´¢å¼•åŠ å¯†

**cache_index.cyrene æ ¼å¼ï¼š**
```
[åŠ å¯†çš„ JSON æ•°æ®]
```

**åŠ å¯†æ–¹å¼ï¼š**
- ä½¿ç”¨ XOR å¼‚æˆ–åŠ å¯†
- å¯†é’¥ï¼š`CyreneMusicCacheKey2025`
- å¯¹ç§°åŠ å¯†ï¼ˆåŠ å¯† = è§£å¯†ï¼‰

**å†…å®¹ç¤ºä¾‹ï¼ˆè§£å¯†åï¼‰ï¼š**
```json
{
  "netease_123456": {
    "songId": "123456",
    "songName": "æ¼”å‘˜",
    "artists": "è–›ä¹‹è°¦",
    "source": "netease",
    "quality": "exhigh",
    ...
  },
  "qq_789012": {
    ...
  }
}
```

---

## ğŸš€ å¦‚ä½•éªŒè¯

### 1. è¿è¡Œåº”ç”¨

```bash
flutter run
```

### 2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è·¯å¾„

**å¼€å‘ç¯å¢ƒæ—¥å¿—ç¤ºä¾‹ï¼š**
```
ğŸ“‚ [CacheService] è¿è¡Œç›®å½•: D:\work\cyrene_music\build\windows\x64\runner\Release
ğŸ“‚ [CacheService] ç¼“å­˜ç›®å½•è·¯å¾„: D:\work\cyrene_music\build\windows\x64\runner\Release\music_cache
âœ… [CacheService] ç¼“å­˜ç›®å½•å·²åˆ›å»º
ğŸ“ [CacheService] ç¼“å­˜ä½ç½®: D:\work\cyrene_music\build\windows\x64\runner\Release\music_cache
```

### 3. å¯¼èˆªåˆ°ç¼“å­˜ç›®å½•

**å¿«æ·æ–¹å¼ï¼š**
1. å¤åˆ¶æ—¥å¿—ä¸­çš„è·¯å¾„
2. æŒ‰ `Win + R`
3. ç²˜è´´è·¯å¾„
4. å›è½¦

**æˆ–æ‰‹åŠ¨ï¼š**
1. æ‰“å¼€é¡¹ç›®ç›®å½•ï¼š`D:\work\cyrene_music`
2. è¿›å…¥ï¼š`build\windows\x64\runner\Release\`
3. æŸ¥æ‰¾ï¼š`music_cache` æ–‡ä»¶å¤¹

### 4. æ’­æ”¾å¹¶éªŒè¯

1. æ’­æ”¾ä»»æ„æ­Œæ›²
2. ç­‰å¾…ç¼“å­˜å®Œæˆ
3. åˆ·æ–°ç¼“å­˜ç›®å½•
4. åº”è¯¥çœ‹åˆ°ï¼š
   - `cache_index.cyrene` âœ… åŠ å¯†çš„ç´¢å¼•
   - `netease_XXXXX.cyrene` âœ… æ­Œæ›²ç¼“å­˜

**å°è¯•ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼š**
- æ‰€æœ‰æ–‡ä»¶éƒ½åº”è¯¥æ˜¾ç¤ºä¸ºä¹±ç ï¼ˆåŠ å¯†ç”Ÿæ•ˆï¼‰

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### ä»£ç æ”¹åŠ¨

**lib/services/cache_service.dart:**

1. **ç¼“å­˜ç›®å½•è·å–ï¼š**
```dart
if (Platform.isWindows) {
  // Windows: ä½¿ç”¨å½“å‰è¿è¡Œç›®å½•
  final executablePath = Platform.resolvedExecutable;
  final executableDir = path.dirname(executablePath);
  _cacheDir = Directory(path.join(executableDir, 'music_cache'));
} else {
  // å…¶ä»–å¹³å°: ä½¿ç”¨åº”ç”¨æ–‡æ¡£ç›®å½•
  final appDir = await getApplicationDocumentsDirectory();
  _cacheDir = Directory('${appDir.path}/music_cache');
}
```

2. **ç´¢å¼•æ–‡ä»¶åŠ å¯†ï¼š**
```dart
// ä¿å­˜
final jsonBytes = utf8.encode(jsonEncode(indexData));
final encryptedData = _encryptData(jsonBytes);
await File('cache_index.cyrene').writeAsBytes(encryptedData);

// è¯»å–
final encryptedData = await File('cache_index.cyrene').readAsBytes();
final decryptedData = _decryptData(encryptedData);
final indexJson = utf8.decode(decryptedData);
```

---

## âš ï¸ è¿ç§»æŒ‡å—

### å¦‚æœä½ æœ‰æ—§ç¼“å­˜

**æ–¹æ³• 1ï¼šæ¸…é™¤æ—§ç¼“å­˜**
1. æ‰“å¼€è®¾ç½® â†’ å­˜å‚¨ â†’ æ¸…é™¤ç¼“å­˜
2. é‡æ–°æ’­æ”¾æ­Œæ›²ï¼Œç”Ÿæˆæ–°æ ¼å¼ç¼“å­˜

**æ–¹æ³• 2ï¼šæ‰‹åŠ¨è¿ç§»ï¼ˆä¸æ¨èï¼‰**
1. åˆ é™¤æ—§çš„ `C:\Users\{ç”¨æˆ·å}\Documents\music_cache\`
2. æ–°ç¼“å­˜ä¼šè‡ªåŠ¨åœ¨è¿è¡Œç›®å½•ç”Ÿæˆ

### ç‰ˆæœ¬å…¼å®¹æ€§

- **v1.3.0** â†’ **v1.3.1**ï¼šä¸å…¼å®¹ï¼Œéœ€è¦æ¸…é™¤æ—§ç¼“å­˜
- ç´¢å¼•æ–‡ä»¶ä» `.json` æ”¹ä¸º `.cyrene`
- ç¼“å­˜ç›®å½•ä½ç½®å˜æ›´ï¼ˆä»… Windowsï¼‰

---

## ğŸ“š æ›´æ–°çš„æ–‡æ¡£

- âœ… `docs/MUSIC_CACHE.md` - æ›´æ–°ç¼“å­˜ä½ç½®è¯´æ˜
- âœ… `docs/CACHE_TROUBLESHOOTING.md` - æ›´æ–°è·¯å¾„ç¤ºä¾‹
- âœ… `docs/CYRENE_FILE_FORMAT.md` - æ·»åŠ ç´¢å¼•æ–‡ä»¶è¯´æ˜
- âœ… `CACHE_TEST.md` - æ›´æ–°æµ‹è¯•å‘½ä»¤

---

## ğŸ‰ æ”¹è¿›æ€»ç»“

### ä¼˜åŠ¿

1. **Windows ç”¨æˆ·ä½“éªŒæå‡**
   - ç¼“å­˜æ–‡ä»¶ä¸åº”ç”¨åœ¨åŒä¸€ä½ç½®
   - æ›´å®¹æ˜“æ‰¾åˆ°å’Œç®¡ç†
   - å¸è½½åº”ç”¨æ—¶ç¼“å­˜ä¹Ÿä¼šè¢«åˆ é™¤

2. **å®‰å…¨æ€§å¢å¼º**
   - ç´¢å¼•æ–‡ä»¶ä¹ŸåŠ å¯†äº†
   - æ‰€æœ‰ `.cyrene` æ–‡ä»¶éƒ½æ— æ³•ç›´æ¥æŸ¥çœ‹
   - é˜²æ­¢ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ç´¢å¼•

3. **æ ¼å¼ç»Ÿä¸€**
   - æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯ `.cyrene` æ‰©å±•å
   - æ¸…æ™°çš„æ–‡ä»¶ç±»å‹æ ‡è¯†
   - ä¸“ä¸šçš„æ ¼å¼è®¾è®¡

### æ–‡ä»¶æ¸…å•

**ç¼“å­˜ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š**
```
music_cache/
â”œâ”€â”€ cache_index.cyrene        â† åŠ å¯†çš„ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ netease_123456.cyrene     â† æ­Œæ›²ç¼“å­˜ï¼ˆå«å…ƒæ•°æ® + éŸ³é¢‘ï¼‰
â”œâ”€â”€ qq_789012.cyrene
â””â”€â”€ kugou_345678.cyrene
```

**æ‰€æœ‰æ–‡ä»¶éƒ½ï¼š**
- âœ… ä½¿ç”¨ `.cyrene` æ‰©å±•å
- âœ… ç»è¿‡ XOR åŠ å¯†
- âœ… æ— æ³•ç›´æ¥æ‰“å¼€æˆ–æ’­æ”¾

---

## âœ… æµ‹è¯•æ¸…å•

è¿è¡Œåº”ç”¨åï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

- [ ] æ§åˆ¶å°æ˜¾ç¤º `ğŸ“‚ [CacheService] è¿è¡Œç›®å½•: ...`
- [ ] èƒ½åœ¨è¿è¡Œç›®å½•æ‰¾åˆ° `music_cache` æ–‡ä»¶å¤¹
- [ ] æ’­æ”¾æ­Œæ›²åç”Ÿæˆ `.cyrene` æ–‡ä»¶
- [ ] `cache_index.cyrene` æ–‡ä»¶å­˜åœ¨
- [ ] ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ `.cyrene` æ–‡ä»¶æ˜¾ç¤ºä¹±ç 
- [ ] è®¾ç½®é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„ç¼“å­˜æ•°é‡
- [ ] å†æ¬¡æ’­æ”¾ä½¿ç”¨ç¼“å­˜

---

**ç‰ˆæœ¬ï¼š** v1.3.1  
**æ—¥æœŸï¼š** 2025-10-02  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

**å…³é”®æ”¹è¿›ï¼š**
- ğŸ” ç´¢å¼•æ–‡ä»¶åŠ å¯†
- ğŸ“ Windows ç¼“å­˜ä½ç½®ä¼˜åŒ–

