# 缓存功能 v1.3.2 更新总结

## 🎯 新增功能

### 1. 缓存开关 🔧

**位置：** 设置 → 存储 → 启用缓存

**功能：**
- 一键开启/关闭缓存功能
- 实时生效，无需重启
- 设置自动持久化

**实现：**
```dart
// CacheService
bool _cacheEnabled = true;  // 默认开启

Future<void> setCacheEnabled(bool enabled) async {
  _cacheEnabled = enabled;
  await _saveCacheEnabled();
  notifyListeners();
}
```

**使用场景：**
- 存储空间不足时关闭
- 使用流量时关闭
- 需要时随时开启

### 2. 自定义缓存目录 📁

**位置：** 设置 → 存储 → 缓存目录

**功能：**
- 自由设置缓存存储位置
- 自动验证目录权限
- 恢复默认目录功能

**实现：**
```dart
// CacheService
String? _customCacheDir;

Future<bool> setCustomCacheDir(String? dirPath) async {
  // 验证目录
  final dir = Directory(dirPath);
  if (!await dir.exists()) {
    await dir.create(recursive: true);
  }
  
  // 测试写入权限
  final testFile = File('${dir.path}/.test');
  await testFile.writeAsString('test');
  await testFile.delete();
  
  _customCacheDir = dirPath;
  await _saveCustomCacheDir();
  return true;
}
```

**使用场景：**
- C 盘空间不足，改用 D 盘
- 使用外部存储（移动硬盘）
- 多设备共享缓存（网络目录）

---

## 📊 设置界面

### 存储部分（新增）

```
┌─────────────────────────────────┐
│ 存储                            │
├─────────────────────────────────┤
│ ☁️ 启用缓存          [✅ 开启]   │
│    自动缓存播放过的歌曲          │
├─────────────────────────────────┤
│ 📁 缓存目录          →          │
│    默认位置                     │
├─────────────────────────────────┤
│ 💾 缓存管理          →          │
│    已缓存 25 首歌曲              │
├─────────────────────────────────┤
│ 🗑️ 清除缓存          →          │
│    清空所有缓存的歌曲            │
└─────────────────────────────────┘
```

### 缓存目录对话框

```
┌─────────────────────────────────────┐
│ 📁 缓存目录设置                      │
├─────────────────────────────────────┤
│ 当前目录：                          │
│ D:\work\...\Release\music_cache     │
│                                     │
│ ─────────────────────────────────  │
│                                     │
│ 默认目录：                          │
│ D:\work\...\Release\music_cache     │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 📝 自定义目录（留空使用默认）    │ │
│ │ 例：D:\Music\Cache              │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ⚠️ 提示                             │
│ • 更改目录需要重启应用生效          │
│ • 确保目录有读写权限                │
│ • 旧缓存不会自动迁移                │
└─────────────────────────────────────┘
  [恢复默认]  [取消]  [保存]
```

---

## 🔧 技术实现

### 设置持久化

**保存的数据：**
```json
{
  "cache_enabled": true,
  "custom_cache_dir": "D:\\Music\\Cache"
}
```

**存储键名：**
- `cache_enabled` - 缓存开关状态（Boolean）
- `custom_cache_dir` - 自定义目录路径（String）

### 初始化流程

```
应用启动
    ↓
加载缓存设置
    ↓
确定缓存目录
├─ 有自定义目录？
│  ├─ 是 → 使用自定义目录
│  └─ 否 → 使用默认目录
│      ├─ Windows → 运行目录\music_cache
│      └─ 其他 → 应用数据目录\music_cache
    ↓
创建目录
    ↓
验证权限
    ↓
加载缓存索引
    ↓
初始化完成 ✅
```

### 缓存逻辑

```dart
// 检查缓存
if (!cacheEnabled) return false;  // 开关检查
if (!isCached(track)) return false;

// 缓存歌曲
if (!cacheEnabled) {
  print('缓存已禁用，跳过');
  return false;
}
```

---

## 📝 代码改动

### 修改的文件

1. **lib/services/cache_service.dart**
   - ✅ 添加 `_cacheEnabled` 和 `_customCacheDir` 字段
   - ✅ 实现 `setCacheEnabled()` 方法
   - ✅ 实现 `setCustomCacheDir()` 方法
   - ✅ 添加 `_loadSettings()` 和保存方法
   - ✅ 修改初始化逻辑支持自定义目录
   - ✅ 修改 `isCached()` 和 `cacheSong()` 检查开关

2. **lib/pages/settings_page.dart**
   - ✅ 添加「启用缓存」开关
   - ✅ 添加「缓存目录」设置项
   - ✅ 实现 `_showCacheDirSettings()` 对话框
   - ✅ 更新缓存状态显示逻辑

3. **README.md**
   - ✅ 更新版本号到 v1.3.2
   - ✅ 添加新功能说明

### 新增的文档

- ✅ `docs/CACHE_SETTINGS.md` - 设置功能详细说明
- ✅ `docs/CACHE_QUICK_GUIDE.md` - 快速使用指南
- ✅ `CACHE_v1.3.2_SUMMARY.md` - 更新总结

---

## 🎨 用户界面

### 设置页面新增项

**1. 缓存开关（Switch）**
- 图标：☁️ cloud_download
- 标题：启用缓存
- 副标题：
  - 开启：「自动缓存播放过的歌曲」
  - 关闭：「缓存已禁用」

**2. 缓存目录（ListTile）**
- 图标：📁 folder
- 标题：缓存目录
- 副标题：
  - 默认：「默认位置」
  - 自定义：「自定义：{路径}」

### 缓存目录对话框

**显示内容：**
- 当前使用的目录
- 系统默认目录
- 自定义目录输入框
- 提示信息

**操作按钮：**
- 「恢复默认」- 清除自定义设置
- 「取消」- 不保存
- 「保存」- 保存并提示重启

---

## 📊 默认值

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| 缓存开关 | ✅ 开启 | 自动缓存歌曲 |
| 缓存目录 | 运行目录 | Windows: 应用目录/music_cache |

---

## ⚠️ 重要提示

### 1. 目录更改需要重启

**为什么？**
- 缓存服务在启动时初始化目录
- 运行时更改会导致路径混乱
- 重启确保目录切换完整

**提示：**
- 保存后会显示重启提示
- 重启前播放的歌曲可能缓存到旧目录

### 2. 旧缓存不会迁移

**说明：**
- 更改目录后，旧缓存仍在旧目录
- 新缓存会保存到新目录
- 可以手动复制文件迁移

**手动迁移：**
```
1. 打开旧缓存目录
2. 复制所有 .cyrene 文件
3. 粘贴到新目录
4. 重启应用
```

### 3. 目录权限要求

**必须：**
- ✅ 目录存在或可创建
- ✅ 有读权限
- ✅ 有写权限

**测试：**
应用会自动测试目录权限，失败时会提示。

---

## 🎯 测试建议

### 测试 1：缓存开关

1. 开启缓存 → 播放歌曲 → 检查是否缓存 ✅
2. 关闭缓存 → 播放新歌 → 应该不缓存 ❌
3. 再次开启 → 播放新歌 → 恢复缓存 ✅

### 测试 2：自定义目录

1. 设置自定义目录（如 `D:\Test`）
2. 保存并重启
3. 查看日志确认目录
4. 播放歌曲
5. 检查 `D:\Test\music_cache\` 是否有文件

### 测试 3：恢复默认

1. 点击「恢复默认」
2. 重启应用
3. 缓存应该回到默认目录

---

## 📚 完整功能列表

✅ **已实现：**
- [x] 缓存开关
- [x] 自定义缓存目录
- [x] 目录验证
- [x] 设置持久化
- [x] 恢复默认功能
- [x] 实时状态显示
- [x] 错误提示

📋 **文档完善：**
- [x] 功能说明文档
- [x] 快速使用指南
- [x] 更新总结

---

**版本：** v1.3.2  
**状态：** ✅ 功能完整  
**测试：** ✅ 无错误  
**文档：** ✅ 已完善

