# 后端连接测试规范

## 📡 健康检查端点

### 请求规范

**端点**: `/`  
**方法**: `GET`  
**超时**: 10 秒

### 成功响应标准

连接被视为成功需要同时满足：

1. ✅ **HTTP 状态码**: `200`
2. ✅ **响应体**: `OK`（严格匹配，区分大小写）

### 示例

#### ✅ 成功示例

**请求**:
```http
GET http://127.0.0.1:4055/
```

**响应**:
```http
HTTP/1.1 200 OK
Content-Type: text/plain

OK
```

#### ❌ 失败示例 1 - 错误状态码

**响应**:
```http
HTTP/1.1 404 Not Found
Content-Type: text/plain

OK
```
❌ 状态码不是 200

#### ❌ 失败示例 2 - 错误响应体

**响应**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{"status": "ok"}
```
❌ 响应体不是纯文本 "OK"

#### ❌ 失败示例 3 - 连接超时

无响应超过 10 秒  
❌ 连接超时

## 🔧 前端实现

### 连接测试逻辑

```dart
Future<void> testConnection() async {
  final baseUrl = UrlService().baseUrl;
  
  try {
    // 发送 GET 请求到根路径
    final response = await http.get(
      Uri.parse(baseUrl),
    ).timeout(
      const Duration(seconds: 10),
      onTimeout: () {
        throw Exception('连接超时');
      },
    );

    // 检查响应码是否为 200 且响应体是 "OK"
    if (response.statusCode == 200 && response.body.trim() == 'OK') {
      // ✅ 连接成功
      print('连接成功');
    } else {
      // ❌ 连接失败
      print('响应码: ${response.statusCode}');
      print('响应内容: ${response.body}');
    }
  } catch (e) {
    // ❌ 连接失败
    print('错误: $e');
  }
}
```

### 用户界面流程

1. **开始测试**
   - 显示加载指示器
   - 禁用用户交互

2. **发送请求**
   - 向当前后端地址发送 GET 请求
   - 等待响应（最多 10 秒）

3. **显示结果**
   - ✅ **成功**: 显示绿色成功提示
   - ❌ **失败**: 显示红色错误提示 + 错误详情

## 🎨 UI 设计

### 成功状态

```
┌─────────────────────────────────┐
│ ✓ 连接测试                      │
├─────────────────────────────────┤
│ 后端地址: http://...            │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ ✓ 连接成功                   │ │ (绿色背景)
│ └─────────────────────────────┘ │
│                                 │
│              [确定]              │
└─────────────────────────────────┘
```

### 失败状态

```
┌─────────────────────────────────┐
│ ✗ 连接测试                      │
├─────────────────────────────────┤
│ 后端地址: http://...            │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ ✗ 连接失败                   │ │ (红色背景)
│ └─────────────────────────────┘ │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 错误详情:                    │ │ (灰色背景)
│ │ Exception: 连接超时           │ │
│ └─────────────────────────────┘ │
│                                 │
│              [确定]              │
└─────────────────────────────────┘
```

## 🔐 安全考虑

### 隐藏官方源地址

在用户界面中，官方源地址应该被隐藏：

- ❌ **不要**: 显示 "官方源 (http://127.0.0.1:4055)"
- ✅ **应该**: 显示 "官方源（默认后端服务）"

**原因**:
- 防止暴露内部端口
- 提升安全性
- 简化用户界面

### 自定义源

自定义源地址可以正常显示：
- ✅ "自定义源 (http://example.com:4055)"

## 🚀 后端实现建议

### Express (Node.js)

```javascript
app.get('/', (req, res) => {
  res.send('OK');
});
```

### Elysia (Bun)

```typescript
app.get('/', () => 'OK');
```

### Flask (Python)

```python
@app.route('/')
def health_check():
    return 'OK'
```

### Spring Boot (Java)

```java
@GetMapping("/")
public String healthCheck() {
    return "OK";
}
```

## 📊 错误处理

### 常见错误及解决方案

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 连接超时 | 后端服务未启动 | 启动后端服务 |
| 连接被拒绝 | 端口未开放或错误 | 检查端口和防火墙 |
| 404 Not Found | 根路径未实现 | 添加健康检查端点 |
| 响应码 500 | 后端服务异常 | 检查后端日志 |
| 响应内容错误 | 返回格式不正确 | 确保返回纯文本 "OK" |

## 🧪 测试示例

### curl 测试

```bash
# 测试官方源
curl http://127.0.0.1:4055/

# 测试自定义源
curl http://your-custom-backend:4055/
```

**预期输出**: `OK`

### Postman 测试

1. 新建 GET 请求
2. URL: `http://127.0.0.1:4055/`
3. 发送请求
4. 检查:
   - Status: `200 OK`
   - Body: `OK`

## 📝 OmniParse 标准

符合 OmniParse 标准的后端必须：

1. ✅ 在根路径 `/` 实现健康检查端点
2. ✅ 返回状态码 200 和纯文本 "OK"
3. ✅ 实现所有必需的 API 端点（音乐、视频等）
4. ✅ 保持 API 响应格式一致

## 🔄 未来扩展

可能的增强功能：

- 检测后端版本号
- 显示后端支持的功能列表
- 测量响应延迟
- 支持 HTTPS
- 自动重试机制
