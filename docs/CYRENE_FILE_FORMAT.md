# .cyrene æ–‡ä»¶æ ¼å¼è§„èŒƒ

## ğŸ“ æ¦‚è¿°

`.cyrene` æ˜¯ Cyrene Music çš„ä¸“æœ‰ç¼“å­˜æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨åŠ å¯†çš„éŸ³ä¹æ•°æ®å’Œå…ƒæ•°æ®ã€‚

**ç”¨é€”ï¼š**
- éŸ³ä¹ç¼“å­˜æ–‡ä»¶ï¼ˆ`{æ¥æº}_{æ­Œæ›²ID}.cyrene`ï¼‰
- ç¼“å­˜ç´¢å¼•æ–‡ä»¶ï¼ˆ`cache_index.cyrene`ï¼‰

**ç‰¹ç‚¹ï¼š**
- âœ… ç»Ÿä¸€çš„æ‰©å±•å
- âœ… å…¨éƒ¨åŠ å¯†å­˜å‚¨
- âœ… æ— æ³•ç›´æ¥æ’­æ”¾æˆ–æŸ¥çœ‹

## ğŸ”§ æ–‡ä»¶ç»“æ„

### äºŒè¿›åˆ¶å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç§»    â”‚ é•¿åº¦         â”‚ å†…å®¹                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x00    â”‚ 4 bytes      â”‚ å…ƒæ•°æ®é•¿åº¦ï¼ˆå¤§ç«¯åºï¼‰ â”‚
â”‚ 0x04    â”‚ N bytes      â”‚ å…ƒæ•°æ® JSON          â”‚
â”‚ 0x04+N  â”‚ å‰©ä½™æ‰€æœ‰å­—èŠ‚  â”‚ åŠ å¯†çš„éŸ³é¢‘æ•°æ®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­—æ®µè¯¦è§£

#### 1. å…ƒæ•°æ®é•¿åº¦ï¼ˆ4 å­—èŠ‚ï¼‰

- **æ ¼å¼ï¼š** 32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¤§ç«¯åºï¼ˆBig-Endianï¼‰
- **èŒƒå›´ï¼š** 0 - 4,294,967,295
- **ç”¨é€”ï¼š** æŒ‡ç¤ºåç»­å…ƒæ•°æ® JSON çš„å­—èŠ‚é•¿åº¦

**ç¼–ç ç¤ºä¾‹ï¼š**
```dart
// å¦‚æœå…ƒæ•°æ®é•¿åº¦ä¸º 256 å­—èŠ‚
bytes[0] = 0x00;  // (256 >> 24) & 0xFF
bytes[1] = 0x00;  // (256 >> 16) & 0xFF
bytes[2] = 0x01;  // (256 >> 8) & 0xFF
bytes[3] = 0x00;  // 256 & 0xFF
```

**è§£ç ç¤ºä¾‹ï¼š**
```dart
final metadataLength = (bytes[0] << 24) | 
                       (bytes[1] << 16) | 
                       (bytes[2] << 8) | 
                       bytes[3];
```

#### 2. å…ƒæ•°æ® JSONï¼ˆN å­—èŠ‚ï¼‰

- **æ ¼å¼ï¼š** UTF-8 ç¼–ç çš„ JSON å­—ç¬¦ä¸²
- **ç¼–ç ï¼š** UTF-8
- **é•¿åº¦ï¼š** ç”±å‰4å­—èŠ‚æŒ‡å®š

**JSON ç»“æ„ï¼š**
```json
{
  "songId": "1234567",
  "songName": "æ¼”å‘˜",
  "artists": "è–›ä¹‹è°¦",
  "source": "netease",
  "quality": "exhigh",
  "originalUrl": "http://music.163.com/...",
  "fileSize": 5242880,
  "cachedAt": "2025-10-02T15:30:00.000Z",
  "checksum": "a1b2c3d4e5f6789..."
}
```

**å­—æ®µç±»å‹ï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| songId | String | æ­Œæ›²å”¯ä¸€æ ‡è¯† |
| songName | String | æ­Œæ›²åç§° |
| artists | String | è‰ºæœ¯å®¶ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ |
| source | String | æ¥æºï¼šnetease/qq/kugou |
| quality | String | éŸ³è´¨ç­‰çº§ |
| originalUrl | String | åŸå§‹ä¸‹è½½é“¾æ¥ |
| fileSize | Number | åŸå§‹éŸ³é¢‘å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| cachedAt | String | ISO 8601 æ—¶é—´æˆ³ |
| checksum | String | MD5 æ ¡éªŒå’Œï¼ˆåå…­è¿›åˆ¶ï¼‰ |

#### 3. åŠ å¯†çš„éŸ³é¢‘æ•°æ®ï¼ˆå‰©ä½™å­—èŠ‚ï¼‰

- **æ ¼å¼ï¼š** äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®ï¼ˆé€šå¸¸æ˜¯ MP3/FLAC ç­‰ï¼‰
- **åŠ å¯†ï¼š** XOR å¼‚æˆ–åŠ å¯†
- **å¯†é’¥ï¼š** `CyreneMusicCacheKey2025`

**åŠ å¯†ç®—æ³•ï¼š**
```dart
Uint8List encryptData(Uint8List data) {
  final keyBytes = utf8.encode('CyreneMusicCacheKey2025');
  final encrypted = Uint8List(data.length);
  
  for (int i = 0; i < data.length; i++) {
    encrypted[i] = data[i] ^ keyBytes[i % keyBytes.length];
  }
  
  return encrypted;
}
```

**ç‰¹ç‚¹ï¼š**
- å¯¹ç§°åŠ å¯†ï¼ˆåŠ å¯† = è§£å¯†ï¼‰
- è½»é‡å¿«é€Ÿ
- é˜²æ­¢ç›´æ¥æ’­æ”¾

## ğŸ“ æ–‡ä»¶å¤§å°è®¡ç®—

```
æ€»å¤§å° = 4 + å…ƒæ•°æ®é•¿åº¦ + éŸ³é¢‘æ•°æ®é•¿åº¦
```

**ç¤ºä¾‹ï¼š**
- å…ƒæ•°æ®ï¼š256 å­—èŠ‚
- éŸ³é¢‘ï¼š5,242,880 å­—èŠ‚ï¼ˆ5 MBï¼‰
- æ€»è®¡ï¼š5,243,140 å­—èŠ‚ï¼ˆçº¦ 5.00 MBï¼‰

## ğŸ” å®‰å…¨æ€§

### åŠ å¯†ç›®çš„

- âœ… é˜²æ­¢ç¼“å­˜æ–‡ä»¶è¢«ç›´æ¥ä½¿ç”¨
- âœ… ç‰ˆæƒä¿æŠ¤ï¼ˆéä¸‹è½½ï¼Œä»…ç¼“å­˜ï¼‰
- âœ… ç¡®ä¿åªèƒ½é€šè¿‡åº”ç”¨æ’­æ”¾

### å®‰å…¨çº§åˆ«

- **åŠ å¯†å¼ºåº¦ï¼š** ä½ï¼ˆXOR åŠ å¯†ï¼‰
- **ä¿æŠ¤ç›®æ ‡ï¼š** é˜²æ­¢æ™®é€šç”¨æˆ·ç›´æ¥ä½¿ç”¨
- **éç›®æ ‡ï¼š** ä¸ç”¨äºé«˜å¼ºåº¦åŠ å¯†ä¿æŠ¤

**æ³¨æ„ï¼š** XOR åŠ å¯†å¯ä»¥è¢«é€†å‘ï¼Œä½†å·²è¶³å¤Ÿé˜²æ­¢æ™®é€šç”¨æˆ·ç›´æ¥æ’­æ”¾ç¼“å­˜æ–‡ä»¶ã€‚

## ğŸ› ï¸ è¯»å†™æ“ä½œ

### å†™å…¥ .cyrene æ–‡ä»¶

```dart
// 1. å‡†å¤‡å…ƒæ•°æ®
final metadata = {...};
final metadataJson = jsonEncode(metadata);
final metadataBytes = utf8.encode(metadataJson);
final metadataLength = metadataBytes.length;

// 2. åŠ å¯†éŸ³é¢‘æ•°æ®
final encryptedAudio = encryptData(audioData);

// 3. æ„å»ºæ–‡ä»¶
final cyreneFile = BytesBuilder();

// å†™å…¥é•¿åº¦ï¼ˆ4å­—èŠ‚å¤§ç«¯åºï¼‰
cyreneFile.addByte((metadataLength >> 24) & 0xFF);
cyreneFile.addByte((metadataLength >> 16) & 0xFF);
cyreneFile.addByte((metadataLength >> 8) & 0xFF);
cyreneFile.addByte(metadataLength & 0xFF);

// å†™å…¥å…ƒæ•°æ®
cyreneFile.add(metadataBytes);

// å†™å…¥åŠ å¯†éŸ³é¢‘
cyreneFile.add(encryptedAudio);

// 4. ä¿å­˜æ–‡ä»¶
await File('song.cyrene').writeAsBytes(cyreneFile.toBytes());
```

### è¯»å– .cyrene æ–‡ä»¶

```dart
// 1. è¯»å–æ–‡ä»¶
final fileData = await File('song.cyrene').readAsBytes();

// 2. è¯»å–å…ƒæ•°æ®é•¿åº¦
final metadataLength = (fileData[0] << 24) |
                       (fileData[1] << 16) |
                       (fileData[2] << 8) |
                       fileData[3];

// 3. è¯»å–å…ƒæ•°æ®
final metadataBytes = fileData.sublist(4, 4 + metadataLength);
final metadataJson = utf8.decode(metadataBytes);
final metadata = jsonDecode(metadataJson);

// 4. è¯»å–åŠ å¯†çš„éŸ³é¢‘æ•°æ®
final encryptedAudio = fileData.sublist(4 + metadataLength);

// 5. è§£å¯†éŸ³é¢‘
final decryptedAudio = decryptData(encryptedAudio);

// 6. æ’­æ”¾
await audioPlayer.play(DeviceFileSource(tempFile));
```

## ğŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§

### 1. æ£€æŸ¥æ–‡ä»¶å¤´

```dart
bool isValidCyreneFile(File file) {
  final bytes = await file.readAsBytes();
  
  // è‡³å°‘éœ€è¦4å­—èŠ‚
  if (bytes.length < 4) return false;
  
  final metadataLength = (bytes[0] << 24) | 
                         (bytes[1] << 16) | 
                         (bytes[2] << 8) | 
                         bytes[3];
  
  // æ–‡ä»¶å¤§å°å¿…é¡» >= 4 + å…ƒæ•°æ®é•¿åº¦
  return bytes.length >= 4 + metadataLength;
}
```

### 2. éªŒè¯æ ¡éªŒå’Œ

```dart
// ä»å…ƒæ•°æ®ä¸­è·å–åŸå§‹æ ¡éªŒå’Œ
final expectedChecksum = metadata['checksum'];

// è®¡ç®—è§£å¯†åçš„éŸ³é¢‘æ ¡éªŒå’Œ
final actualChecksum = md5.convert(decryptedAudio).toString();

// éªŒè¯
if (expectedChecksum != actualChecksum) {
  throw Exception('æ–‡ä»¶å·²æŸå');
}
```

## ğŸ“Š æ–‡ä»¶ç¤ºä¾‹

### æ–‡ä»¶å¤§å°å¯¹æ¯”

| æ ¼å¼ | åŸå§‹éŸ³é¢‘ | å…ƒæ•°æ® | .cyrene æ–‡ä»¶ |
|------|---------|--------|-------------|
| MP3 æ ‡å‡† | 3.5 MB | 256 B | 3.5 MB |
| MP3 æé«˜ | 8.2 MB | 256 B | 8.2 MB |
| FLAC æ— æŸ | 32.1 MB | 256 B | 32.1 MB |

**æ³¨æ„ï¼š** åŠ å¯†ä¸å¢åŠ æ–‡ä»¶å¤§å°ï¼Œ`.cyrene` æ–‡ä»¶å¤§å° â‰ˆ åŸå§‹éŸ³é¢‘å¤§å° + å…ƒæ•°æ®å¤§å°ï¼ˆé€šå¸¸å¯å¿½ç•¥ï¼‰ã€‚

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

### å½“å‰ç‰ˆæœ¬ï¼šv1.0

- **æ ¼å¼ç‰ˆæœ¬ï¼š** 1.0
- **å‘åå…¼å®¹ï¼š** æœªæ¥ç‰ˆæœ¬å¯èƒ½æ·»åŠ ç‰ˆæœ¬å­—æ®µ
- **å»ºè®®ï¼š** åœ¨å…ƒæ•°æ®ä¸­æ·»åŠ  `formatVersion` å­—æ®µ

### æœªæ¥æ‰©å±•

å¯èƒ½çš„æ”¹è¿›ï¼š

1. **æ·»åŠ ç‰ˆæœ¬å·** - æ”¯æŒæ ¼å¼å‡çº§
2. **å‹ç¼©å…ƒæ•°æ®** - ä½¿ç”¨ gzip å‹ç¼© JSON
3. **æ›´å¼ºåŠ å¯†** - ä½¿ç”¨ AES åŠ å¯†
4. **ç­¾åéªŒè¯** - é˜²æ­¢æ–‡ä»¶è¢«ç¯¡æ”¹
5. **åˆ†å—å­˜å‚¨** - æ”¯æŒå¤§æ–‡ä»¶

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤§ç«¯åº** - å…ƒæ•°æ®é•¿åº¦ä½¿ç”¨å¤§ç«¯åºå­˜å‚¨
2. **UTF-8 ç¼–ç ** - å…ƒæ•°æ®å¿…é¡»ä½¿ç”¨ UTF-8
3. **å®Œæ•´æ€§** - åˆ é™¤æ–‡ä»¶æ—¶åˆ é™¤å¯¹åº”çš„ç¼“å­˜ç´¢å¼•æ¡ç›®
4. **å”¯ä¸€æ€§** - åŒä¸€é¦–æ­Œåªèƒ½æœ‰ä¸€ä¸ªç¼“å­˜æ–‡ä»¶

## ğŸ“š å‚è€ƒå®ç°

**å®Œæ•´å®ç°ï¼š** `lib/services/cache_service.dart`

---

**ç‰ˆæœ¬ï¼š** 1.0  
**æœ€åæ›´æ–°ï¼š** 2025-10-02  
**çŠ¶æ€ï¼š** ç¨³å®š

