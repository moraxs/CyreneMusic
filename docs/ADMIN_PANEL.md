# 管理员后台功能说明

## 📝 功能概述

Cyrene Music 现已支持**管理员后台系统**，开发者可以通过开发者模式访问数据标签页，输入管理员密码后查看和管理用户数据库。

## ✨ 功能特点

- 🔐 **密码验证** - 需要输入管理员密码才能访问
- 👥 **用户管理** - 查看所有注册用户的详细信息
- 📊 **数据统计** - 丰富的用户统计和趋势分析
- 🗑️ **用户删除** - 支持删除用户（危险操作）
- 🔄 **会话管理** - 管理员登录会话有效期1小时
- 💾 **本地缓存** - 令牌本地缓存，重启应用保持登录状态

## 🔑 管理员密码

**默认管理员密码：** `morax2237`

可以在 `backend/config.json` 中修改：
```json
{
  "admin": {
    "password": "morax2237",
    "session_duration": 3600
  }
}
```

## 🚀 使用方法

### 1. 进入开发者模式

在设置页面底部，快速点击版本号 5 次即可进入开发者模式。

### 2. 访问数据标签页

在开发者页面中，切换到「数据」标签页。

### 3. 管理员登录

首次访问会看到登录界面：
- 输入管理员密码：`morax2237`
- 点击「登录」按钮
- 登录成功后自动加载用户数据

### 4. 查看用户列表

**用户列表标签页** 显示所有注册用户：
- 用户头像（如有QQ邮箱自动显示QQ头像）
- 用户名和邮箱
- 验证状态（绿色勾标记）
- 点击展开查看详细信息：
  - 用户ID
  - 注册时间
  - 最后登录时间
  - IP地址和归属地
  - 验证状态和验证时间

**删除用户：**
- 点击用户卡片右侧的删除图标
- 确认删除对话框
- ⚠️ 此操作不可撤销！

### 5. 查看统计数据

**统计数据标签页** 提供完整的数据分析：

**用户概览：**
- 📊 总用户数
- ✅ 已验证用户数
- ⏳ 未验证用户数
- 🆕 今日新增用户
- 📈 今日活跃用户
- 📅 本周新增用户

**地区分布 Top 10：**
- 柱状图展示用户地理分布
- 显示每个地区的用户数量
- 按用户数量排序

**注册趋势：**
- 最近30天的注册趋势
- 累计注册人数统计

### 6. 刷新数据

点击顶部工具栏的刷新按钮，重新从服务器获取最新数据。

### 7. 退出管理员

点击顶部工具栏的「退出」按钮，清除登录状态和本地令牌。

## 🏗️ 技术实现

### 后端部分

#### 1. 配置文件 (`backend/config.json`)

```json
{
  "admin": {
    "password": "morax2237",
    "session_duration": 3600
  }
}
```

#### 2. 管理员控制器 (`backend/src/lib/adminController.ts`)

**核心功能：**
- 管理员登录验证
- 会话令牌管理
- 权限验证中间件
- 用户数据查询
- 统计数据计算
- 用户删除操作

**会话管理：**
- 使用 Map 在内存中存储会话
- 每个会话有创建时间和过期时间
- 定期清理过期会话（每10分钟）
- 重启服务器后会话失效

#### 3. API 端点

| 方法 | 路径 | 说明 | 需要权限 |
|------|------|------|---------|
| POST | `/admin/login` | 管理员登录 | ❌ |
| POST | `/admin/logout` | 管理员登出 | ✅ |
| GET | `/admin/users` | 获取用户列表 | ✅ |
| GET | `/admin/stats` | 获取统计数据 | ✅ |
| DELETE | `/admin/users` | 删除用户 | ✅ |

**权限验证：**
- 通过 Authorization Header 传递令牌
- 格式：`Bearer {token}`
- 令牌无效返回 401 状态码

### 前端部分

#### 1. AdminService (`lib/services/admin_service.dart`)

**数据模型：**
- `AdminUserData` - 用户数据模型（包含所有字段）
- `UserStats` - 统计数据模型
- `LocationStat` - 地区统计
- `TrendData` - 趋势数据

**核心方法：**
- `login(password)` - 管理员登录
- `logout()` - 管理员登出
- `fetchUsers()` - 获取用户列表
- `fetchStats()` - 获取统计数据
- `deleteUser(userId)` - 删除用户

**本地存储：**
- 令牌存储在 SharedPreferences
- 应用重启后自动恢复登录状态
- 服务器返回 401 时自动清除令牌

#### 2. 开发者页面 (`lib/pages/developer_page.dart`)

**数据标签页结构：**
```
数据标签页
├── 未登录：管理员登录界面
│   ├── 密码输入框
│   └── 登录按钮
└── 已登录：管理员面板
    ├── 工具栏
    │   ├── 刷新按钮
    │   └── 退出按钮
    └── 子标签页
        ├── 用户列表
        │   └── 用户卡片（可展开）
        └── 统计数据
            ├── 用户概览
            ├── 地区分布
            └── 注册趋势
```

## 📊 数据流程

### 登录流程

```
用户输入密码
   ↓
POST /admin/login
   ↓
后端验证密码
   ↓
生成会话令牌
   ↓
返回令牌和过期时间
   ↓
前端保存令牌到本地
   ↓
自动加载用户数据和统计
```

### 数据查询流程

```
前端发起请求
   ↓
携带 Authorization Header
   ↓
后端验证令牌
   ↓
令牌有效？
├── 是：查询数据库
│   └── 返回数据
└── 否：返回 401
    └── 前端清除登录状态
```

## 🔒 安全特性

### 1. 密码验证

- ✅ 密码在后端配置文件中存储（明文）
- ✅ 登录失败记录日志
- ⚠️ 注意：不要在生产环境使用简单密码

### 2. 会话管理

- ✅ 令牌随机生成（32字符16进制）
- ✅ 会话有有效期（默认1小时）
- ✅ 服务器重启后所有会话失效
- ✅ 过期会话自动清理

### 3. 权限控制

- ✅ 所有管理员接口都需要验证令牌
- ✅ 令牌无效自动返回 401
- ✅ 前端收到 401 自动退出登录

### 4. 数据保护

- ✅ 用户密码不返回给前端
- ✅ 用户数据仅管理员可见
- ✅ 删除操作需要二次确认

## ⚠️ 注意事项

### 1. 生产环境建议

**强烈建议修改默认密码！**

在 `backend/config.json` 中设置复杂密码：
```json
{
  "admin": {
    "password": "your_strong_password_here",
    "session_duration": 3600
  }
}
```

**密码要求：**
- 至少12个字符
- 包含大小写字母、数字和特殊字符
- 不要使用常见密码

### 2. 会话时长

默认会话时长为 3600 秒（1小时），可以根据需要调整：
```json
{
  "admin": {
    "session_duration": 7200  // 2小时
  }
}
```

### 3. 删除用户

⚠️ **危险操作：** 删除用户会永久删除数据库中的用户记录，包括：
- 用户基本信息
- 登录历史
- IP归属地记录

此操作**不可撤销**！

### 4. 多人同时管理

当前实现支持多个管理员同时登录，每个登录都有独立的会话令牌。

## 📝 统计数据说明

### 用户概览

- **总用户数：** 数据库中的用户总数
- **已验证用户：** 完成邮箱验证的用户数
- **未验证用户：** 尚未验证邮箱的用户数
- **今日新增：** 今天注册的新用户数
- **今日活跃：** 今天登录过的用户数
- **本周新增：** 最近7天注册的用户数

### 地区分布

- 统计所有用户的 IP 归属地
- 显示用户数量最多的前 10 个地区
- 柱状图宽度表示用户数量占比

### 注册趋势

- 显示最近 30 天的注册趋势
- 每天的新增用户数
- 累计注册用户统计

## 🐛 故障排除

### 问题1：密码正确但无法登录

**可能原因：**
- 后端服务器未启动
- 配置文件读取失败

**解决方案：**
1. 检查后端服务器状态
2. 查看后端日志
3. 确认 `config.json` 格式正确

### 问题2：登录成功但无法查看数据

**可能原因：**
- 数据库不存在或为空
- 令牌已过期
- 网络连接问题

**解决方案：**
1. 检查数据库文件是否存在
2. 尝试重新登录
3. 查看前端控制台日志

### 问题3：删除用户失败

**可能原因：**
- 用户不存在
- 数据库锁定
- 权限不足

**解决方案：**
1. 刷新用户列表
2. 检查用户ID是否正确
3. 查看后端日志

## 📚 相关文件

### 后端

- `backend/config.json` - 管理员配置
- `backend/src/lib/adminController.ts` - 管理员控制器
- `backend/src/lib/database.ts` - 数据库操作
- `backend/src/index.ts` - API 路由

### 前端

- `lib/services/admin_service.dart` - 管理员服务
- `lib/pages/developer_page.dart` - 开发者页面

## 🔄 版本历史

**v1.2.0** (2025-10-02)
- ✅ 添加管理员后台系统
- ✅ 用户列表查看和管理
- ✅ 完整的统计数据可视化
- ✅ 用户删除功能
- ✅ 会话管理和权限控制

## 🎯 未来扩展

可以考虑的增强功能：

1. **用户编辑** - 支持编辑用户信息
2. **批量操作** - 批量删除、批量验证
3. **导出数据** - 导出用户列表为CSV/Excel
4. **操作日志** - 记录管理员的所有操作
5. **更多统计** - 更详细的数据分析和图表
6. **实时更新** - WebSocket 实时推送数据变化
7. **角色权限** - 多级别管理员权限
8. **数据备份** - 一键备份和恢复数据库

---

**注意：** 管理员后台是敏感功能，请妥善保管管理员密码，不要泄露给非授权人员！

