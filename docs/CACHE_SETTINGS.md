# 缓存设置功能说明

## 📝 功能概述

Cyrene Music v1.3.2 新增了**缓存控制功能**，用户可以：
- ✅ 开启/关闭缓存功能
- ✅ 自定义缓存目录位置
- ✅ 实时查看当前缓存状态

## ✨ 主要功能

### 1️⃣ 缓存开关

**位置：** 设置 → 存储 → 启用缓存

**功能：**
- 🟢 **开启**：自动缓存播放过的歌曲
- 🔴 **关闭**：不缓存任何歌曲，已有缓存仍可使用

**特点：**
- ✅ 实时生效，无需重启
- ✅ 设置自动保存
- ✅ 关闭后不影响已有缓存
- ✅ 默认开启

### 2️⃣ 自定义缓存目录

**位置：** 设置 → 存储 → 缓存目录

**功能：**
- 📁 自定义缓存文件存储位置
- 🔄 恢复默认目录
- 📊 显示当前目录和默认目录

**特点：**
- ⚠️ 需要重启应用生效
- ✅ 自动验证目录权限
- ✅ 不会自动迁移旧缓存

## 🎯 使用方法

### 开启/关闭缓存

1. 打开「设置」页面
2. 找到「存储」部分
3. 切换「启用缓存」开关
   - 🟢 开启：自动缓存播放过的歌曲
   - 🔴 关闭：停止缓存新歌曲

**立即生效，无需重启！**

### 设置自定义目录

1. 打开「设置」→「存储」
2. 点击「缓存目录」
3. 在对话框中：
   - 查看当前目录
   - 查看默认目录
   - 输入自定义目录路径
4. 点击「保存」
5. **重启应用**生效

**目录示例：**
```
Windows:
D:\Music\Cache
E:\MyCache
F:\Cyrene\MusicCache

其他平台:
/home/user/music_cache
~/Music/Cache
```

### 恢复默认目录

1. 打开「设置」→「存储」→「缓存目录」
2. 点击「恢复默认」按钮
3. 确认操作
4. 重启应用生效

## 📁 目录说明

### 默认目录

**Windows（开发环境）：**
```
D:\work\cyrene_music\build\windows\x64\runner\Release\music_cache\
```

**Windows（发布版本）：**
```
C:\Program Files\Cyrene Music\music_cache\
```

**Android：**
```
/data/user/0/com.example.cyrene_music/app_flutter/music_cache/
```

**macOS：**
```
~/Library/Application Support/com.example.cyrene_music/music_cache/
```

**Linux：**
```
~/.local/share/cyrene_music/music_cache/
```

### 自定义目录要求

✅ **必须满足：**
- 目录存在或可创建
- 有读写权限
- 有足够的存储空间

❌ **不支持：**
- 网络驱动器（可能很慢）
- 只读目录
- 系统保护目录

## 💡 使用场景

### 场景 1：节省系统盘空间

**问题：** C盘空间不足

**解决：**
1. 设置缓存目录为其他盘符
2. 例：`D:\Cyrene\Cache`
3. 重启应用

### 场景 2：使用外部存储

**问题：** 想将缓存存储在移动硬盘

**解决：**
1. 连接移动硬盘（如 E: 盘）
2. 设置缓存目录为 `E:\Music\Cache`
3. 重启应用

### 场景 3：临时禁用缓存

**问题：** 存储空间紧张，暂时不想缓存

**解决：**
1. 关闭「启用缓存」开关
2. 立即生效
3. 需要时再开启

### 场景 4：多设备共享缓存

**问题：** 多台电脑想共享缓存

**解决：**
1. 将缓存目录设为网络共享文件夹
2. 所有设备设置相同的缓存目录
3. ⚠️ 注意：网络目录可能影响性能

## ⚙️ 设置持久化

### 保存的设置

| 设置项 | 键名 | 类型 | 默认值 |
|--------|------|------|--------|
| 缓存开关 | `cache_enabled` | Boolean | true |
| 自定义目录 | `custom_cache_dir` | String | null |

### 存储位置

**Windows：**
```
%APPDATA%\Roaming\cyrene_music\shared_preferences\
```

**Android：**
```
SharedPreferences (系统默认位置)
```

## 🔧 技术细节

### 缓存开关逻辑

```dart
// 检查缓存
bool isCached(Track track) {
  if (!_isInitialized || !_cacheEnabled) return false;
  return _cacheIndex.containsKey(cacheKey);
}

// 缓存歌曲
Future<bool> cacheSong(...) async {
  if (!_cacheEnabled) {
    print('缓存功能已禁用，跳过缓存');
    return false;
  }
  // ... 缓存逻辑
}
```

### 目录验证

设置自定义目录时会进行验证：

1. **创建测试** - 尝试创建目录（如不存在）
2. **写入测试** - 创建测试文件并写入
3. **删除测试** - 删除测试文件
4. **验证通过** - 保存设置

**失败情况：**
- 目录路径无效
- 无创建权限
- 无写入权限
- 磁盘空间不足

## 📊 状态显示

### 设置页面显示

**缓存开关：**
- 🟢 开启：「自动缓存播放过的歌曲」
- 🔴 关闭：「缓存已禁用」

**缓存目录：**
- 默认：「默认位置」
- 自定义：「自定义：D:\Music\Cache」

**缓存管理：**
- 未初始化：「初始化中...」
- 已禁用：「缓存功能已禁用」
- 无缓存：「暂无缓存」
- 有缓存：「已缓存 X 首歌曲」

## ⚠️ 注意事项

### 1. 目录更改需要重启

**为什么？**
- 缓存服务在应用启动时初始化
- 运行时更改目录会导致路径混乱
- 重启确保目录切换完整

**操作流程：**
1. 设置新目录
2. 看到提示：「请重启应用生效」
3. 关闭并重启应用
4. 新目录生效

### 2. 旧缓存不会迁移

更改目录后：
- ✅ 新缓存会保存到新目录
- ❌ 旧目录的缓存不会自动迁移
- ℹ️ 可以手动复制 `.cyrene` 文件

**手动迁移：**
```
1. 复制旧目录下的所有 .cyrene 文件
2. 粘贴到新目录
3. 重启应用
4. 应用会自动识别
```

### 3. 网络目录性能

如果使用网络共享目录：
- ⚠️ 读写速度可能较慢
- ⚠️ 影响播放体验
- ⚠️ 网络断开会导致错误

**建议：** 使用本地磁盘目录。

### 4. 权限问题

某些目录可能需要管理员权限：
- ❌ `C:\Program Files\`
- ❌ `C:\Windows\`
- ✅ `D:\Music\` （推荐）
- ✅ `E:\Cache\` （推荐）

## 🐛 故障排除

### 问题 1：设置自定义目录失败

**可能原因：**
- 路径格式错误
- 目录无权限
- 磁盘已满

**解决方法：**
1. 检查路径格式（使用反斜杠 `\` 或正斜杠 `/`）
2. 确保目录有读写权限
3. 检查磁盘空间

### 问题 2：关闭缓存后仍在缓存

**可能原因：**
- 设置未保存
- 应用状态未刷新

**解决方法：**
1. 检查开关状态
2. 重启应用
3. 查看日志确认

### 问题 3：更改目录后找不到缓存

**原因：** 旧缓存在旧目录，新目录为空

**解决方法：**
1. 导航到旧目录
2. 复制所有 `.cyrene` 文件
3. 粘贴到新目录
4. 重启应用

## 📝 配置示例

### 示例 1：使用 D 盘缓存

```
自定义目录：D:\Cyrene\MusicCache
```

**文件位置：**
```
D:\Cyrene\MusicCache\
├── cache_index.cyrene
├── netease_123456.cyrene
└── qq_789012.cyrene
```

### 示例 2：便携版设置

如果想做成便携版（缓存随应用走）：

```
自定义目录：.\cache

（相对路径，相对于可执行文件）
```

**注意：** 某些平台可能不支持相对路径，建议使用绝对路径。

## 📚 相关文档

- [MUSIC_CACHE.md](MUSIC_CACHE.md) - 缓存功能总览
- [CYRENE_FILE_FORMAT.md](CYRENE_FILE_FORMAT.md) - 文件格式规范
- [CACHE_TROUBLESHOOTING.md](CACHE_TROUBLESHOOTING.md) - 故障排除

---

**版本：** v1.3.2  
**新增：** 缓存开关 + 自定义目录  
**最后更新：** 2025-10-02

